!function(){"use strict";function a(a,b,c,d,e,f,g,h){function i(){return m.loading?null:m.readSettings().then(function(a){m.groups.length&&(m.groups.length=0),a&&_.each(a,function(a){m.groups.push(a)}),j()})}function j(){function a(a){if("stage"===a.type){var b=m.stageLookup[a._id];if(b){var c=m.deskLookup[b.desk];a.header=c.name,a.subheader=b.name}else a.header="Deleted desk or stage"}"search"===a.type&&(a.search=m.searchLookup[a._id],a.header=a.search?a.search.name:"Deleted saved search"),"personal"===a.type&&(a.header=h("Personal"))}var b=m.groups;angular.forEach(b,a),m.cards=b}var k="agg:view",l=10,m=this;this.loading=!0,this.selected=null,this.groups=[],this.spikeGroups=null,this.allStages=null,this.allDesks=null,this.modalActive=!1,this.searchLookup={},this.deskLookup={},this.stageLookup={},this.fileTypes=["all","text","picture","composite","video","audio"],this.selectedFileType=[],this.monitoringSearch=!1,d.initialize().then(angular.bind(this,function(){return d.fetchCurrentUserDesks().then(angular.bind(this,function(a){this.desks=a._items,this.deskLookup=d.deskLookup,this.deskStages=d.deskStages,_.each(this.desks,function(a){_.each(m.deskStages[a._id],function(a){m.stageLookup[a._id]=a})})}))})).then(angular.bind(this,function(){return b.query("saved_searches",{},c.identity).then(angular.bind(this,function(a){this.searches=a._items,_.each(this.searches,function(a){m.searchLookup[a._id]=a})}))})).then(angular.bind(this,function(){return this.readSettings().then(angular.bind(this,function(a){a&&_.each(a,angular.bind(this,function(a){this.groups.push(a)})),j(),this.loading=!1}))})),this.readSettings=function(){return e.getActiveId().then(angular.bind(this,function(a){if(a)return f.get(k).then(angular.bind(this,function(b){return b&&b[a]&&b[a].groups?b[a].groups:void 0}));var b=this.deskLookup[d.getCurrentDeskId()];return b&&b.monitoring_settings?b.monitoring_settings:[]}))},this.refreshGroups=i,a.$watch(function(){return e.active},i),this.hasFileType=function(a){return"all"===a?0===this.selectedFileType.length:this.selectedFileType.indexOf(a)>-1},this.getSelectedFileTypes=function(){return 0===this.selectedFileType.length?null:JSON.stringify(this.selectedFileType)},this.setFileType=function(a){if("all"===a)this.selectedFileType=[];else{var b=this.selectedFileType.indexOf(a);b>-1?this.selectedFileType.splice(b,1):this.selectedFileType.push(a)}var c=0===this.selectedFileType.length?null:JSON.stringify(this.selectedFileType);_.each(this.groups,function(a){a.fileType=c}),this.allStages&&_.each(this.allStages,function(a){a.fileType=c}),this.spikeGroups&&_.each(this.spikeGroups,function(a){a.fileType=c}),this.allDesks&&_.each(this.allDesks,function(a){a.fileType=c})},this.preview=function(a){this.selected=a},this.edit=function(){this.editGroups={},_.each(this.groups,function(a,b){if(("search"!==a.type||m.searchLookup[a._id])&&(m.editGroups[a._id]={_id:a._id,selected:!0,type:a.type,max_items:a.max_items||l,order:b},"stage"===a.type)){var c=m.stageLookup[a._id];if(!c)return;m.editGroups[c.desk]={_id:c._id,selected:!0,type:"desk",order:0}}}),this.modalActive=!0},this.search=function(a){_.each(this.groups,function(b){b.query=a}),this.allStages&&_.each(this.allStages,function(b){b.query=a}),this.spikeGroups&&_.each(this.spikeGroups,function(b){b.query=a}),this.allDesks&&_.each(this.allDesks,function(b){b.query=a})},this.resetSearch=function(){_.each(this.groups,function(a){a.query=null}),this.allStages&&_.each(this.allStages,function(a){a.query=null}),this.spikeGroups&&_.each(this.spikeGroups,function(a){a.query=null}),this.allDesks&&_.each(this.allDesks,function(a){a.query=null})},this.getSpikeGroups=function(){if(this.groups.length>0){if(!this.spikeGroups){var a={};_.each(this.groups,function(b,c){if("stage"===b.type){var d=m.stageLookup[b._id];a[d.desk]=m.deskLookup[d.desk].name}}),this.spikeGroups=Object.keys(a).map(function(b){return{_id:b,type:"spike",header:a[b]}})}return this.spikeGroups}return this.allDesks||(this.allDesks=Object.keys(this.deskLookup).map(function(a){return{_id:a,type:"spike",header:m.deskLookup[a].name}})),this.allDesks},this.state=g.getItem("agg:state")||{},this.state.expanded=this.state.expanded||{},this.switchExpandedState=function(a){this.state.expanded[a]=!this.getExpandedState(a),g.setItem("agg:state",this.state)},this.getExpandedState=function(a){return void 0===this.state.expanded[a]?!0:this.state.expanded[a]},this.setSoloGroup=function(a){this.state.solo=a,g.setItem("agg:state",this.state)},this.getMaxHeightStyle=function(a){var b=32*(a||l)+6;return{"max-height":b.toString()+"px"}}}function b(a,b,c,d){return{templateUrl:"scripts/superdesk-desks/views/aggregate-settings-configuration.html",scope:{modalActive:"=",desks:"=",deskStages:"=",searches:"=",deskLookup:"=",stageLookup:"=",searchLookup:"=",groups:"=",editGroups:"=",onclose:"&",widget:"@"},link:function(e,f){var g="agg:view",h=10;e.step={current:"desks"},e.closeModal=function(){e.step.current="desks",e.modalActive=!1,e.onclose()},e.previous=function(){d.wizard("aggregatesettings").previous()},e.next=function(){d.wizard("aggregatesettings").next()},e.cancel=function(){e.closeModal()},e.setDeskInfo=function(a){var b=e.editGroups[a];b._id=a,b.type="desk",b.order=0},e.setStageInfo=function(a){var b=e.editGroups[a];b.type||(b._id=a,b.type="stage",b.max_items=h,b.order=_.size(e.editGroups))},e.setSearchInfo=function(a){var b=e.editGroups[a];b.type||(b._id=a,b.type="search",b.max_items=h,b.order=_.size(e.editGroups))},e.setPersonalInfo=function(){var a=e.editGroups.personal;a.type||(a._id="personal",a.type="personal",a.max_items=h,a.order=_.size(e.editGroups))},e.getValues=function(){var a=Object.keys(e.editGroups).map(function(a){return e.editGroups[a]});return a=_.filter(a,function(a){if("desk"===a.type||!a.selected)return!1;if("stage"===a.type){var b=e.stageLookup[a._id];return b&&b.desk?e.editGroups[b.desk].selected:!1}return"personal"===a.type?e.editGroups.personal.selected:!0}),a=_.sortBy(a,function(a){return a.order})},e.reorder=function(a,b){var c=e.getValues();b.index!==a.index&&(c.splice(b.index,0,c.splice(a.index,1)[0]),_.each(c,function(a,b){a.order=b}))},e.save=function(){var f=[];_.each(e.getValues(),function(a,b){a.selected&&"desk"!==a.type&&f.push({_id:a._id,type:a.type,max_items:a.max_items})});var h={};b.getActiveId().then(function(b){b?c.get(g).then(function(a){a&&(h[g]=a),h[g][b]={groups:f},c.update(h,g).then(function(){d.wizard("aggregatesettings").finish()})}):a.save(e.deskLookup[a.getCurrentDeskId()],{monitoring_settings:f}).then(function(){d.wizard("aggregatesettings").finish()})}),e.onclose()}}}}function c(){return{link:function(a,b){var c=!1;b.sortable({items:".sort-item",cursor:"move",containment:".groups",tolerance:"pointer",placeholder:{element:function(a){var b=a.height()-20;return $('<li class="placeholder" style="height:'+b+'px"></li>')[0]},update:function(){}},start:function(a,b){b.item.data("start_index",b.item.parent().find("li.sort-item").index(b.item))},stop:function(b,d){if(c){c=!1;var e={index:d.item.data("start_index")},f={index:d.item.parent().find("li.sort-item").index(d.item)};d.item.remove(),a.reorder(e,f),a.$apply()}},update:function(a,b){c=!0},cancel:".fake"})}}}a.$inject=["$scope","api","session","desks","workspaces","preferencesService","storage","gettext"],b.$inject=["desks","workspaces","preferencesService","WizardHandler"],angular.module("superdesk.aggregate",["superdesk.authoring.widgets","superdesk.desks","superdesk.workspace"]).controller("AggregateCtrl",a).directive("sdAggregateSettings",b).directive("sdSortGroups",c)}(),function(){"use strict";angular.module("superdesk.aggregate.widgets",["superdesk.aggregate","superdesk.dashboard.widgets"]).config(["widgetsProvider",function(a){a.widget("aggregate",{label:"Monitoring",multiple:!0,icon:"archive",max_sizex:2,max_sizey:2,sizex:1,sizey:2,thumbnail:"scripts/superdesk-desks/aggregate-widget/thumbnail.svg",template:"scripts/superdesk-desks/aggregate-widget/aggregate-widget.html",configurationTemplate:"scripts/superdesk-desks/aggregate-widget/configuration.html",description:"Displaying the monitoring content view.",custom:!0})}])}(),function(){"use strict";function a(a,b,c,d,e,f){function g(a){function b(a,b){return a.name.localeCompare(b.name)}var c=a._items||[];return c.sort(b),c}var h;b.initialize().then(function(){a.desks=b.desks,a.deskStages=b.deskStages,b.fetchCurrentUserDesks().then(function(a){h=a._items})}),a.statuses=e.statuses,a.online_users=!1,f("roles").query().then(function(b){a.roles=g(b)}),a.privileges=d.privileges,a.views=["content","tasks","users"],a.view=a.views[0],a.setView=function(b){a.view=b},a.changeOnlineUsers=function(b){a.online_users=b},a.isMemberOf=function(a){return _.find(h,{_id:a._id})},a.openDeskView=function(a,d){b.setCurrentDeskId(a._id),c.intent("view",d)},a.$on("desks:refresh:stages",function(c,d){b.refreshStages().then(function(){a.deskStages[d]=b.deskStages[d]})})}function b(a,b,c,d,e,f,g,h,i){return{templateUrl:"scripts/superdesk-desks/views/stage-item-list.html",scope:{stage:"=",total:"=",allowed:"=",showEmpty:"=?",maxItems:"=?",selected:"=?",action:"&",filter:"="},link:function(a,j){function k(c){o=e.criteria(a.stage,c),a.loading=!0,a.items=a.total=null,b("archive").query(o).then(function(b){a.items=b._items,a.total=b._meta.total,a.cachePreviousItems=b._items,l(o)})["finally"](function(){a.loading=!1})}function l(c){return c.source.from=a.page*c.source.size,b("archive").query(c).then(function(b){a.cacheNextItems=b._items})}function m(a){h.hash(a),i()}function n(b,c){a.select(b),c&&(c.preventDefault(),c.stopPropagation(),c.stopImmediatePropagation())}var o;a.page=1,a.fetching=!1,a.cacheNextItems=[],a.cachePreviousItems=[],a.preview=function(a){d.setWorkspace(a.task.desk,a.task.stage),sessionStorage.getItem("previewUrl")||sessionStorage.setItem("previewUrl",h.url()),c.intent("read_only","content_article",a)},a.edit=function(a){d.setWorkspace(a.task.desk,a.task.stage),c.intent("author","article",a)},a.$watch("filter",k),a.$on("task:stage",function(b,c){!a.stage||c.new_stage!==a.stage&&c.old_stage!==a.stage||k()});var p=j[0],q=0;j.bind("scroll",function(){a.$apply(function(){p.scrollTop+p.offsetHeight>=p.scrollHeight-3&&(p.scrollTop=p.scrollTop-3,a.fetchNext()),p.scrollTop<=2&&(q=2-p.scrollTop,p.scrollTop=p.scrollTop+q,a.fetchPrevious())})}),a.fetchNext=function(){return a.fetching?g.when(!1):void(a.cacheNextItems.length>0&&(a.fetching=!0,a.page=a.page+1,o.source.from=a.page*o.source.size,a.loading=!0,a.items.length>o.source.size&&(a.cachePreviousItems=_.slice(a.items,0,o.source.size),a.items.splice(0,o.source.size)),f(function(){_.isEqual(a.items,a.cacheNextItems)||(a.items=a.items.concat(a.cacheNextItems))},100),b("archive").query(o).then(function(b){a.cacheNextItems=b._items,a.fetching=!1},function(){})["finally"](function(){a.loading=!1})))},a.fetchPrevious=function(){return!a.fetching&&a.page>2?(a.fetching=!0,a.page=a.page-1,a.page>2?o.source.from=(a.page-3)*o.source.size:o.source.from=0,a.loading=!0,a.items.length>o.source.size&&(a.cacheNextItems=_.slice(a.items,a.items.length-(a.items.length-o.source.size),a.items.length),a.items.splice(a.items.length-(a.items.length-o.source.size),o.source.size)),f(function(){a.items.unshift.apply(a.items,a.cachePreviousItems),a.items.length>0&&m(a.items[parseInt((a.items.length-1)/2,a.maxItems||10)]._id)},100),b("archive").query(o).then(function(b){a.cachePreviousItems=b._items,a.fetching=!1})["finally"](function(){a.loading=!1}),void 0):g.when(!1)};var r,s=-1,t=1;j.on("keyup",function(b){a.$apply(function(){b.keyCode?r=b.keyCode:b.which&&(r=b.which),38===r&&a.move(s,b),40===r&&(b.preventDefault(),a.move(t,b))})}),a.move=function(b,c){if(null!=a.selected&&a.selected.task.stage===a.stage&&a.items){var d=_.findIndex(a.items,{_id:a.selected._id});-1===d&&n(_.first(a.items),c);var e=_.max([0,_.min([a.items.length-1,d+b])]);0>e&&n(_.last(a.items),c),d!==e?(m(a.items[e]._id),n(a.items[e],c)):c&&(c.preventDefault(),c.stopPropagation(),c.stopImmediatePropagation())}},a.select=function(a){this.selected=a}}}}function c(a,b,c){return{templateUrl:"scripts/superdesk-desks/views/task-status-items.html",scope:{status:"=",desk:"=",total:"="},link:function(d,e){d.users=c.userLookup;var f=a.query({});f.filter({and:[{term:{"task.status":d.status}},{term:{"task.desk":d.desk}}]}),f.size(10);var g={source:f.getCriteria()};d.loading=!0,b("archive").query(g).then(function(a){d.loading=!1,d.items=a._items,d.total=a._meta.total},function(){d.loading=!1})}}}function d(a,b){return{templateUrl:"scripts/superdesk-desks/views/user-role-items.html",scope:{role:"=",desk:"=",total:"=",online:"=",privilege:"="},link:function(c,d){c.users=a.deskMembers[c.desk],c.total=0,c.items=[],c.user=null,_.each(c.users,function(a,b){c.role===a.role&&(c.items.push(a),c.total=c.total+1)}),c.isLoggedIn=function(a){return b.isLoggedIn(a)},c.openEditUser=function(a){c.user=a},c.closeEditUser=function(){c.user=null}}}}function e(a,b){b.initialize().then(function(){a.desks=b.desks})}function f(a,b,c,d,e,f){a.modalActive=!1,a.step={current:null},a.desk={edit:null},a.openDesk=function(b,c){a.modalActive=!0,a.step.current=b,a.desk.edit=c},a.cancel=function(){a.modalActive=!1,a.step.current=null,a.desk.edit=null},a.remove=function(e){f.confirm(b("Please confirm you want to delete desk.")).then(function(){d.remove(e).then(function(d){_.remove(a.desks._items,e),c.success(b("Desk deleted."),3e3)},function(a){angular.isDefined(a.data._message)?c.error(b("Error: "+a.data._message)):c.error(b("Unknown Error: There was a problem, desk was not deleted."))})})}}function g(){return{templateUrl:"scripts/superdesk-desks/views/stage-header.html"}}a.$inject=["$scope","desks","superdesk","privileges","tasks","api"],b.$inject=["search","api","superdesk","desks","cards","$timeout","$q","$location","$anchorScroll"],c.$inject=["search","api","desks"],d.$inject=["desks","usersService"],e.$inject=["$scope","desks"],f.$inject=["$scope","gettext","notify","desks","WizardHandler","modal"];var h=angular.module("superdesk.desks",["superdesk.users","superdesk.authoring.widgets","superdesk.aggregate.widgets","superdesk.aggregate"]),i={stage:15,desk:40};return h.config(["superdeskProvider",function(b){b.activity("/desks/",{label:gettext("Master Desk"),description:gettext("Navigate through the newsroom"),templateUrl:"scripts/superdesk-desks/views/main.html",controller:a,category:b.MENU_MAIN,privileges:{desks:1}}).activity("/settings/desks",{label:gettext("Desks"),controller:e,templateUrl:"scripts/superdesk-desks/views/settings.html",category:b.MENU_SETTINGS,priority:-800,privileges:{desks:1}})}]).config(["apiProvider",function(a){a.api("desks",{type:"http",backend:{rel:"desks"}})}]).factory("desks",["$q","api","preferencesService","userList","notify","session",function(a,b,c,d,e,f){function g(a){a.active&&a.active.desk===a.activeDeskId&&a.active.stage===a.activeStageId||(a.active={desk:a.activeDeskId,stage:a.activeStageId})}function h(a){return i=null,j=null,l.loading=null,a}var i,j,k=function(a,c,d){return c=c||1,d=d||[],b(a).query({max_results:200,page:c}).then(function(b){return d=d.concat(b._items),b._links.next?(c++,k(a,c,d)):d})},l={desks:null,users:null,stages:null,deskLookup:{},stageLookup:{},userLookup:{},deskMembers:{},deskStages:{},loading:null,activeDeskId:null,activeStageId:null,active:{desk:null,stage:null},fetchDesks:function(){var a=this;return k("desks").then(function(b){a.desks={_items:b},_.each(b,function(b){a.deskLookup[b._id]=b})})},fetchUsers:function(){var a=this;return d.getAll().then(function(b){a.users={},a.users._items=b,_.each(b,function(b){a.userLookup[b._id]=b})})},fetchStages:function(){var a=this;return k("stages").then(function(b){a.stages={_items:b},_.each(b,function(b){a.stageLookup[b._id]=b})})},generateDeskMembers:function(){var b=this;return _.each(this.desks._items,function(a){b.deskMembers[a._id]=[],_.each(a.members,function(c,d){var e=_.find(b.users._items,{_id:c.user});e?b.deskMembers[a._id].push(e):console.error("Desk user not found for desk: %s , user missing: %s",a.name,c.user)})}),a.when()},generateDeskStages:function(){var b=this;return this.deskStages=_.groupBy(b.stages._items,"desk"),a.when()},fetchUserDesks:function(a){return b.get(a._links.self.href+"/desks")},fetchCurrentUserDesks:function(){var b=this;return b.userDesks?a.when(b.userDesks):this.fetchCurrentDeskId().then(angular.bind(f,f.getIdentity)).then(angular.bind(this,this.fetchUserDesks)).then(angular.bind(this,function(a){return b.userDesks=a,g(this),a}))},fetchCurrentDeskId:function(){var b=this;return b.activeDeskId?a.when(b.activeDeskId):c.get("desk:last_worked").then(function(a){return b.activeDeskId=null,angular.isDefined(a)&&(b.activeDeskId=a),b.activeDeskId})},fetchCurrentStageId:function(){var b=this;return b.activeStageId?a.when(b.activeStageId):c.get("stage:items").then(function(a){angular.isDefined(a)&&(b.activeStageId=angular.isArray(a)?a[0]:a)})},getCurrentDeskId:function(){return this.userDesks&&this.userDesks._items&&0!==this.userDesks._items.length?this.activeDeskId&&_.find(this.userDesks._items,{_id:this.activeDeskId})?this.activeDeskId:this.userDesks._items[0]._id:null},setCurrentDeskId:function(a){this.activeDeskId!==a&&(this.activeDeskId=a,this.activeStageId=null,g(this),c.update({"desk:last_worked":this.activeDeskId,"stage:items":[]},"desk:last_worked"))},getCurrentStageId:function(){return this.activeStageId},setCurrentStageId:function(a){this.activeStageId!==a&&(this.activeStageId=a,g(this),c.update({"desk:last_worked":this.activeDeskId,"stage:items":[this.activeStageId]},"desk:last_worked"))},fetchDeskById:function(a){return b.desks.getById(a)},getCurrentDesk:function(){return this.deskLookup[this.getCurrentDeskId()]||null},setWorkspace:function(a,b){a=a||null,b=b||null,(this.activeDeskId!==a||this.activeStageId!==b)&&(this.activeDeskId=a,this.activeStageId=b,g(this),c.update({"desk:last_worked":this.activeDeskId,"stage:items":[this.activeStageId]},"desk:last_worked"))},initialize:function(){return this.loading||(this.fetchCurrentDeskId(),this.fetchCurrentStageId(),this.loading=this.fetchUsers().then(angular.bind(this,this.fetchDesks)).then(angular.bind(this,this.generateDeskMembers)).then(angular.bind(this,this.fetchStages)).then(angular.bind(this,this.generateDeskStages)).then(angular.bind(this,this.initActive))),this.loading},initActive:function(){g(this)},save:function(a,c){return b.save("desks",a,c).then(h)},remove:function(a){return b.remove(a).then(h)},refreshStages:function(){return this.fetchStages().then(angular.bind(this,this.generateDeskStages))},refreshUsers:function(){return this.fetchUsers().then(angular.bind(this,this.generateDeskMembers))},getItemDesk:function(a){return a.task&&a.task.desk?this.deskLookup[a.task.desk]||null:void 0}};return l}]).directive("sdStageItems",b).directive("sdTaskStatusItems",c).directive("sdUserRoleItems",d).directive("sdDeskConfig",function(){return{controller:f}}).directive("sdDeskConfigModal",function(){return{scope:{modalActive:"=active",desk:"=",step:"=",desks:"=",cancel:"&"},require:"^sdDeskConfig",templateUrl:"scripts/superdesk-desks/views/desk-config-modal.html",link:function(a,b,c,d){}}}).directive("sdFocusElement",[function(){return{link:function(a,b,c){b.click(function(){_.defer(function(){angular.element(document.querySelector(c.target)).focus()})})}}}]).directive("sdContentExpiry",[function(){return{templateUrl:"scripts/superdesk-desks/views/content-expiry.html",scope:{item:"=",preview:"=",header:"@"},link:function(a,b,c){function d(a){return Math.floor(a/60)}function e(a){return Math.floor(a%60)}function f(a){return 60*a.Hours+a.Minutes}var g=c.expiryfield;a.ContentExpiry={Hours:0,Minutes:0,Header:"Content Expiry"},a.$watch("item",function(){h(a.item)}),a.$watch("ContentExpiry",function(){a.item||(a.item={}),a.item[g]=f(a.ContentExpiry)},!0);var h=function(b){a.ContentExpiry.Header=a.header,b&&null!=b[g]&&(a.ContentExpiry.Hours=d(b[g]),a.ContentExpiry.Minutes=e(b[g]))}}}}]).directive("sdDeskeditBasic",["gettext","desks","WizardHandler",function(a,b,c){return{link:function(d,e,f){function g(a){a.data&&a.data._issues&&a.data._issues.name&&a.data._issues.name.unique?d._errorUniqueness=!0:d._error=!0,d.message=null}function h(){(d._errorUniqueness||d._error||d._errorLimits)&&(d._errorUniqueness=null,d._error=null,d._errorLimits=null)}d.limits=i,d.$watch("step.current",function(a){"general"===a&&(d.desk.edit&&d.desk.edit._id&&d.edit(d.desk.edit),d.message=null)}),d.edit=function(a){d.desk.edit=_.create(a)},d.save=function(e){d.message=a("Saving...");var f=e._id?!1:!0;b.save(d.desk.edit,e).then(function(){if(f)d.edit(d.desk.edit),d.desks._items.unshift(d.desk.edit);else{var a=_.find(d.desks._items,{_id:d.desk.edit._id});_.extend(a,d.desk.edit)}b.deskLookup[d.desk.edit._id]=d.desk.edit,c.wizard("desks").next()},g)},d.handleEdit=function(a){h(),null!=d.desk.edit.name&&(d._errorLimits=d.desk.edit.name.length>d.limits.desk?!0:null)}}}}]).directive("sdDeskeditStages",["gettext","api","WizardHandler","tasks","$rootScope","desks","notify","macros",function(a,b,c,d,e,f,g,h){return{link:function(j,k,l){function m(a){a.data&&a.data._issues?a.data._issues.name&&a.data._issues.name.unique?j._errorUniqueness=!0:a.data._issues["validator exception"]&&g.error(a.data._issues["validator exception"]):j._error=!0,j.message=null}function n(){(j._errorUniqueness||j._error||j._errorLimits)&&(j._errorUniqueness=null,j._error=null,j._errorLimits=null)}function o(a,b){e.$broadcast("desks:refresh:stages",j.desk.edit._id)}var p=null;j.limits=i,j.statuses=d.statuses,j.desk.edit&&j.desk.edit._id&&h.getByDesk(j.desk.edit.name).then(function(a){j.macros=a}),j.$watch("step.current",function(a,b){"stages"===a&&(j.editStage=null,p=null,j.stages=[],j.selected=null,j.message=null,j.getstages(b))}),j.getstages=function(a){j.desk.edit&&j.desk.edit._id?(j.message="loading...",b("stages").query({where:{desk:j.desk.edit._id}}).then(function(a){j.stages=a._items,j.message=null})):c.wizard("desks").goTo(a)},j.previous=function(){c.wizard("desks").previous()},j.next=function(){c.wizard("desks").next()},j.edit=function(a){if(null==a.is_visible&&(a.is_visible=!0),p=a,j.editStage=_.create(a),!j.editStage._id){var b=_.last(j.stages);b&&(j.editStage.task_status=b.task_status)}},j.isActive=function(a){return j.editStage&&j.editStage._id===a._id},j.cancel=function(){j.editStage=null,n()},j.select=function(a){return j.editStage&&j.editStage._id!==a._id?!1:void(j.selected=a)},j.setStatus=function(a){j.editStage.task_status=a._id},j.save=function(){p._id?b("stages").save(p,j.editStage).then(function(a){j.editStage=null,j.message=null,j.select(a),o(),j.getstages(),f.fetchDeskById(a.desk).then(function(a){j.desk.edit=a})},m):(_.extend(j.editStage,{desk:j.desk.edit._id}),b("stages").save({},j.editStage).then(function(a){j.stages.push(a),j.editStage=null,j.select(a),j.message=null,o(),j.getstages(),f.fetchDeskById(a.desk).then(function(a){j.desk.edit=a})},m))},j.handleEdit=function(a){n(),null!=j.editStage.name&&(j._errorLimits=j.editStage.name.length>j.limits.stage?!0:null)},j.remove=function(c){b("stages").remove(c).then(function(){c===j.selected&&(j.selected=null),_.remove(j.stages,c),j.message=null,o(c._id),f.fetchDeskById(c.desk).then(function(a){j.desk.edit=a})},function(b){j.message=a("There was a problem, stage was not deleted.")})}}}}]).directive("sdUserSelectList",["$filter","api",function(a,b){return{scope:{exclude:"=",onchoose:"&"},templateUrl:"scripts/superdesk-desks/views/user-select.html",link:function(a,c,d){function e(){return a.selected?_.findIndex(a.users._items,a.selected):-1}function f(){var b=e();b>0&&a.select(a.users._items[_.max([0,b-1])])}function g(){var b=e();a.select(a.users._items[_.min([a.users._items.length-1,b+1])])}var h=38,i=40,j=13;a.selected=null,a.search=null,a.users={},a.exclude=[];var k=function(){return a.users={},b("users").query({where:JSON.stringify({$or:[{username:{$regex:a.search,$options:"-i"}},{first_name:{$regex:a.search,$options:"-i"}},{last_name:{$regex:a.search,$options:"-i"}},{email:{$regex:a.search,$options:"-i"}}]})}).then(function(b){a.users=b,a.users._items=_.filter(a.users._items,function(b){return-1===_.findIndex(a.exclude,{_id:b._id})}),a.selected=null})},l=_.debounce(k,1e3);a.$watch("search",function(){a.search&&l()}),c.bind("keydown keypress",function(b){a.$apply(function(){switch(b.which){case h:b.preventDefault(),f();break;case i:b.preventDefault(),g();break;case j:b.preventDefault(),e()>=0&&a.choose(a.selected)}})}),a.choose=function(b){a.onchoose({user:b}),a.search=null},a.select=function(b){a.selected=b}}}}]).directive("sdDeskeditPeople",["gettext","WizardHandler","desks","$rootScope",function(a,b,c,d){return{link:function(d,e,f){d.$watch("step.current",function(a,e){"people"===a&&(d.search=null,d.deskMembers=[],d.message="loading...",d.desk.edit&&d.desk.edit._id?c.fetchUsers().then(function(a){d.users=c.users._items,d.deskMembers=c.deskMembers[d.desk.edit._id]||[],d.message=null}):b.wizard("desks").goTo(e))}),d.add=function(a){d.deskMembers.push(a)},d.remove=function(a){_.remove(d.deskMembers,a)},d.previous=function(){b.wizard("desks").previous()},d.save=function(){var e=_.map(d.deskMembers,function(a){return{user:a._id}});c.save(d.desk.edit,{members:e}).then(function(a){_.extend(d.desk.edit,a),c.deskMembers[d.desk.edit._id]=d.deskMembers;var e=c.deskLookup[d.desk.edit._id];_.extend(e,d.desk.edit),b.wizard("desks").next()},function(b){d.message=a("There was a problem, members not saved.")})}}}}]).directive("sdDeskeditMacros",["macros","WizardHandler","desks","$rootScope",function(a,b,c,d){return{link:function(c){c.desk&&c.desk.edit&&a.getByDesk(c.desk.edit.name).then(function(a){c.macros=a}),c.previous=function(){b.wizard("desks").previous()},c.save=function(){b.wizard("desks").finish()}}}}]).directive("sdActionPicker",["desks","macros",function(a,b){return{scope:{desk:"=",stage:"=",macro:"="},templateUrl:"scripts/superdesk-desks/views/actionpicker.html",link:function(c,d,e){c.desks=null,c.deskStages=null,c.deskMacros=null,c.$watchGroup(["desk","stage"],function(){c.desks&&c.deskStages?c.desk&&(b.getByDesk(a.deskLookup[c.desk].name).then(function(a){c.deskMacros=a}),-1===_.findIndex(c.deskStages[c.desk],{_id:c.stage})&&(c.stage=null)):a.initialize().then(function(){c.desks=a.desks._items,c.deskStages=a.deskStages})})}}}]).directive("sdStageHeader",g),h}(),function(){"use strict";function a(a,b){return angular.extend(a,_.pick(b,_.keys(y)))}function b(a){var b=["headline","abstract"];_.each(b,function(b){if(angular.isDefined(a[b])){var c=document.createElement("div");c.innerHTML=a[b],""!==c.textContent&&(a[b]=c.textContent)}})}function c(a,b){_.each(y,function(c,d){a[d]?b[d]?a[d]=b[d]:a[d]=c:b[d]&&(a[d]=b[d])})}function d(b,c,d){var e="archive_autosave",f=3e3,g={};this.open=function(a){return a._locked||a.read_only?b.when(a):d.find(e,a._id).then(function(b){return a._autosave=b,a},function(b){return a})},this.save=function(b){return this.stop(b),g[b._id]=c(function(){var c=a({_id:b._id},b);return null===c.publish_schedule&&delete c.publish_schedule,d.save(e,{},c).then(function(c){a(b,c);var d=Object.getPrototypeOf(b);d._autosave=c})},f),g[b._id]},this.stop=function(a){g[a._id]&&(c.cancel(g[a._id]),g[a._id]=null)},this.drop=function(a){this.stop(a),angular.isDefined(a._autosave)&&null!==a._autosave&&d(e).remove(a._autosave),a._autosave=null}}function e(c,d,e,f,g,h,i){var j=this;this.limits={slugline:24,headline:64,"abstract":160},this.userDesks=[],i.fetchCurrentUserDesks().then(function(a){j.userDesks=a._items}),this.open=function(a,b,c){return angular.isDefined(c)&&"legal_archive"===c?d.find("legal_archive",a).then(function(a){return a._editable=!1,a}):d.find("archive",a,{embedded:{lock_user:1}}).then(function(a){return a._editable=!b,e.lock(a)}).then(function(a){return f.open(a)})},this.close=function(a,b,d,h){var i=c.when();return this.isEditable(a)&&(d&&(i=g.confirm().then(angular.bind(this,function(){return this.save(b,a)}),function(){return c.when("ignore")})),i=i.then(function(c){return c&&"ignore"===c&&f.drop(b),h?void 0:e.unlock(a)})),i},this.publishConfirmation=function(a,b,d,e){var f=c.when();return this.isEditable(b)&&d&&(f=g.confirmPublish(e).then(angular.bind(this,function(){return!0}),function(){return!1})),f},this.publish=function(c,f,g){g=g||"publish",f=a({},f),f.publish_schedule||delete f.publish_schedule,b(f);var h="archive_"+g;return d.update(h,c,f).then(function(a){return e.unlock(a).then(function(a){return a})},function(a){return a})},this.saveWorkConfirmation=function(a,b,d,e){var f=c.when();return d&&this.isEditable(b)&&(f=g.confirmSaveWork(e).then(angular.bind(this,function(){return this.saveWork(a,b)}),function(a){return c.when()})),f},this.autosave=function(a){return f.save(a)},this.save=function(g,h){var i=a({},h);return angular.isDefined(g)&&angular.forEach(_.keys(i),function(a){_.isEqual(i[a],g[a])&&delete i[a]}),b(i),f.stop(h),_.size(i)>0?d.save("archive",h,i).then(function(a){return h._autosave=null,h._locked=e.isLocked(h),h}):c.when(g)},this.saveWork=function(b,c){var e={type:b.type,version:1,task:{desk:null,stage:null,user:b.task.user}},f=_.omit(c,["unique_name","unique_id","_id","guid"]),g=a(e,f);return d.save("archive",{},g).then(function(a){return a._autosave=null,a})},this.isEditable=function(a){return!!a.lock_user&&!e.isLocked(a)},this.isPublished=function(a){return _.contains(["published","killed","scheduled","corrected"],a.state)},this.unlock=function(a,b){f.stop(a),a.lock_session=null,a.lock_user=null,a._locked=!1,g.unlock(b)},this.lock=function(a,b){f.stop(a),d.find("users",b).then(function(b){a.lock_user=b},function(c){a.lock_user=b}),a._locked=!0},this.linkItem=function(a,b,c){var e={};return b&&(e.link_id=b),c&&(e.desk=c),d.save("archive_link",{},e,a)},this.itemActions=function(a){var b=a&&angular.isDefined(a.archive_item)?a.archive_item:a,c=h.privileges,d=angular.extend({},z);if(angular.isUndefined(b)||angular.isUndefined(c)||"killed"===b.state||angular.isDefined(b.takes)&&"killed"===b.takes.state)return d;var f=_.contains(["spiked","scheduled","killed"],b.state)||angular.isDefined(b.package_type)&&"takes"===b.package_type,g=!e.isLocked(b);if(d.new_take=!f&&("text"===b.type||"preformatted"===b.type)&&(angular.isUndefined(b.takes)||b.takes.last_take===b._id)&&(angular.isUndefined(b.more_coming)||!b.more_coming),j.isPublished(b)){if(angular.isDefined(a.archive_item)&&a._current_version!==a.archive_item._current_version)return angular.extend({},z);"scheduled"===b.state?d.deschedule=!0:("published"===b.state||"corrected"===b.state)&&(d.kill=c.kill&&g&&!f,d.correct=c.correct&&g&&!f),d.re_write=_.contains(["published","corrected"],b.state)&&_.contains(["text","preformatted"],b.type)&&(angular.isUndefined(b.more_coming)||!b.more_coming)}else{if("spiked"===b.state)return d=angular.extend({},z),d.unspike=!0,d;d.save="spiked"!==b.state,d.publish=!b.marked_for_not_publication&&b.task&&b.task.desk&&c.publish,d.edit=!("composite"===b.type&&"takes"===b.package_type)&&"spiked"!==b.state&&g,d.unspike="spiked"===b.state&&c.unspike,d.spike="spiked"!==b.state&&c.spike&&(angular.isUndefined(b.takes)||b.takes.last_take===b._id),d.send=b._current_version>0&&c.move}if(d.mark_item=b.task&&b.task.desk&&!f&&"takes"!==b.package_type&&c.mark_for_highlights,d.package_item="spiked"!==b.state&&"scheduled"!==b.state&&"takes"!==b.package_type&&"killed"!==b.state,d.multi_edit=_.contains(["text","preformatted"],a.type)&&!f,b.task&&b.task.desk){var i=_.find(j.userDesks,{_id:b.task.desk});i||(d=angular.extend({},z)),d.duplicate=c.duplicate&&!f}else d.copy=!0;return d}}function f(a,b,c,d,e){function f(a){return a.lock_user&&a.lock_user._id||a.lock_user}this.lock=function(d,f){return!d.lock_user&&d._editable||f?b.save("archive_lock",{},{},d).then(function(a){return _.extend(d,a),d._locked=!1,d.lock_user=c.identity._id,d.lock_session=c.sessionId,d},function(a){return e.error(gettext("Failed to get a lock on the item!")),
d._locked=!0,d._editable=!1,d}):(d._locked=this.isLocked(d),a.when(d))},this.unlock=function(a){return b("archive_unlock",a).save({}).then(function(b){return _.extend(a,b),a._locked=!0,a},function(b){return a._locked=!0,a})},this.isLocked=function(a){var b=f(a);return b?b!==c.identity._id?!0:a.lock_session&&a.lock_session!==c.sessionId?!0:!1:!1},this.isLockedByMe=function(a){var b=f(a);return b&&b===c.identity._id},this.can_unlock=function(a){return this.isLockedByMe(a)?!0:d.privileges.unlock}}function g(a,b,c,d,e,f,g){this.setupWindow=function(b){a.onbeforeunload=function(){return b.dirty?f("There are unsaved changes. If you navigate away, your changes will be lost."):void b.$on("$destroy",function(){a.onbeforeunload=angular.noop})}},this.confirm=function(){return e.confirm(f("There are some unsaved changes, do you want to save it now?"),f("Save changes?"),f("Save"),f("Ignore"),f("Cancel"))},this.confirmPublish=function(a){return e.confirm(g(f("There are some unsaved changes, do you want to save it and {{ action }} now?"))({action:a}),f("Save changes?"),g(f("Save and {{ action }}"))({action:a}),f("Cancel"))},this.confirmSaveWork=function(a){return e.confirm(g(f("Configuration has changed, {{ message }}. Would you like to save story to your workspace?"))({message:a}))},this.confirmSpellcheck=function(a){return e.confirm(g(f("You have {{ message }} spelling mistakes. Are you sure you want to continue?"))({message:a}))},this.unlock=function(a){d.find("users",a).then(function(a){var b=f("This item was unlocked by <b>{{ user }}</b>.").replace("{{ user }}",c("username")(a));return e.confirm(b,f("Item Unlocked"),f("OK"),!1)})},this.lock=function(a){d.find("users",a).then(function(a){var b=f("This item was locked by <b>{{ user }}</b>.").replace("{{ user }}",c("username")(a));return e.confirm(b,f("Item locked"),f("OK"),!1)})}}function h(a,b){this.saveCrop=function(c,d){return a.resource("archive").then(function(a){return a=a+"/"+d._id+"/crop/"+d.cropsize.name,b.post(a,{CropLeft:c.CropLeft,CropRight:c.CropRight,CropTop:c.CropTop,CropBottom:c.CropBottom}).then(function(a){return a.data})})}}function i(a,b,c,d,e){function f(b,c){a.data.renditions[c].CropLeft=b.CropLeft,a.data.renditions[c].CropTop=b.CropTop,a.data.renditions[c].CropRight=b.CropRight,a.data.renditions[c].CropBottom=b.CropBottom}a.data=a.locals.data,a.preview={},a.close=function(){return"published"===a.data.state?a.resolve(a.data):(a.reject(),void e.reload())},a.done=function(){var e={};e.CropLeft=Math.round(Math.min(a.preview.cords.x,a.preview.cords.x2)),e.CropRight=Math.round(Math.max(a.preview.cords.x,a.preview.cords.x2)),e.CropTop=Math.round(Math.min(a.preview.cords.y,a.preview.cords.y2)),e.CropBottom=Math.round(Math.max(a.preview.cords.y,a.preview.cords.y2));var g=a.data.cropsize.name;return"published"!==a.data.state?b.saveCrop(e,a.data).then(function(b){var h=b.renditions[g].href;d.success(c("Image Cropped.")),a.data.picture_url=h,f(e,g)},function(a){"ERR"===a.data._status&&d.error(c("Error: "+a.data._error.message))}):(f(e,g),void d.success(c("Crop changes recorded")))}}function j(a,b,c,d){a.origItem=b,a.action=c||"edit",a.lock=function(){d.intent("author","article",b)}}function k(b,d,e,f,g,h,i,j,k,l,m,n,o,p,q,r,s,t){return{link:function(q,r,u){function v(a){i.generate_highlights.save({},{"package":a}).then(d.edit,function(a){e.error(f("Error creating highlight."))})}function w(a){if(_.contains(["published","killed","corrected"],a.state))return!0;if(a.publish_schedule_date&&!a.publish_schedule_time)return e.error(f("Publish Schedule time is invalid!")),!1;if(a.publish_schedule_time&&!a.publish_schedule_date)return e.error(f("Publish Schedule date is invalid!")),!1;if(a.publish_schedule){var b=new Date(a.publish_schedule);if(!_.isDate(b))return e.error(f("Publish Schedule is not a valid date!")),!1;if(b<_.now())return e.error(f("Publish Schedule cannot be earlier than now!")),!1;if(!b.getTime())return e.error(f("Publish Schedule time is invalid!")),!1}return!0}function x(a,b){var c="edit"===q.action?"publish":q.action;h.publish(a,b,c).then(function(a){if(a)if(angular.isDefined(a.data)&&angular.isDefined(a.data._issues)){if(angular.isDefined(a.data._issues["validator exception"])){for(var c=a.data._issues["validator exception"],g=c.replace(/\[/g,"").replace(/\]/g,"").split(","),i=0;i<g.length;i++)e.error(g[i]);(c.indexOf("9007")>=0||c.indexOf("9009")>=0)&&h.open(b._id,!0).then(function(a){q.origItem=a,q.dirty=!1,q.item=_.create(q.origItem)})}}else 412===a.status?(e.error(f("Precondition Error: Item not published.")),q.save_visible=!1):(e.success(f("Item published.")),q.item=a,q.dirty=!1,d.close());else e.error(f("Unknown Error: Item not published."))})}function z(){h.open(q.item._id,!0).then(function(a){q.origItem=a,q.dirty=!1,q.closePreview(),q.item._editable=q._editable})}var A;q.privileges=l.privileges,q.dirty=!1,q.views={send:!1},q.stage=null,q._editable=!!q.origItem._editable,q.isMediaType=_.contains(["audio","video","picture"],q.origItem.type),q.action=q.action||(q._editable?"edit":"view"),q.itemActions=h.itemActions(q.origItem),q.highlight=!!q.origItem.highlight,q.$watch("origItem",function(a,b){q.itemActions=null,a&&(q.itemActions=h.itemActions(a))},!0),q._isInProductionStates=!h.isPublished(q.origItem),q.origItem.sign_off=q.origItem.sign_off||q.origItem.version_creator,"kill"===q.action&&i("content_templates").getById("kill").then(function(a){a=_.pick(a,_.keys(y));var b=a.body_html;if(b){var c=_.words(b,/\${([\s\S]+?)}/g);c=_.map(c,function(a){return _.trim(a,"${} ")});var d=_.template(b),e=_.pick(q.origItem,c);q.origItem.body_html=d(e)}_.each(a,function(a,b){_.isEmpty(a)||"body_html"!==b&&(q.origItem[b]=a)})}),q.$watch("item.marked_for_not_publication",function(a,b){if(a!==b){var c=_.create(q.origItem);q.dirty=!0,c.marked_for_not_publication=a,q.itemActions=h.itemActions(c)}}),q.proofread=!1,q.referrerUrl=o.getReferrerUrl(),q.origItem.task&&q.origItem.task.stage&&(i("stages").getById(q.origItem.task.stage).then(function(a){q.stage=a}),g.fetchDeskById(q.origItem.task.desk).then(function(a){q.deskName=a.name})),q.openStage=function(){g.setWorkspace(q.item.task.desk,q.item.task.stage),b.intent("view","content")},q.save=function(){return h.save(q.origItem,q.item).then(function(a){return q.origItem=a,q.dirty=!1,q.item=_.create(q.origItem),e.success(f("Item updated.")),q.origItem},function(a){angular.isDefined(a.data._issues)?angular.isDefined(a.data._issues.unique_name)&&1===a.data._issues.unique_name.unique?e.error(f("Error: Unique Name is not unique.")):angular.isDefined(a.data._issues["validator exception"])&&e.error(f("Error: "+a.data._issues["validator exception"])):e.error(f("Error. Item not updated."))})},q.exportHighlight=function(a){q.save_enabled()?t.confirm(f("You have unsaved changes, do you want to continue.")).then(function(){v(a._id)}):v(a._id)},q.publish=function(){if(w(q.item))if(q.dirty){var a="kill"===q.action?q.action:"publish";h.publishConfirmation(q.origItem,q.item,q.dirty,a).then(function(a){a&&x(q.origItem,q.item)},function(a){e.error(f("Error. Item not published."))})}else x(q.origItem,q.item)},q.deschedule=function(){return q.item.publish_schedule=null,q.save()},q.close=function(){A=!0,h.close(q.item,q.origItem,q.save_enabled()).then(function(){d.close(q.item)})},q.closeOpenNew=function(a,b){A=!0,h.close(q.item,q.origItem,q.dirty,!0).then(function(){a(b)})},q.beforeSend=function(){return q.sending=!0,q.dirty?q.save().then(function(){return k.unlock(q.origItem)}):k.unlock(q.origItem)},q.preview=function(a){c(q.item,a),q._editable=!1},q.revert=function(a){return c(q.item,a),q.save()},q.closePreview=function(){q.item=_.create(q.origItem),a(q.item,q.item._autosave||{}),q._editable="view"!==q.action&&h.isEditable(q.origItem)},q.can_unlock=function(){return k.can_unlock(q.item)},q.save_enabled=function(){return q.dirty||q.item._autosave},q.unlock=function(){q.unlockClicked=!0,k.unlock(q.item).then(function(a){n.path("/authoring/"+q.item._id)})},q.openAction=function(a){n.path("/authoring/"+q.item._id+"/"+a)},q.isLockedByMe=function(){return k.isLockedByMe(q.item)},q.autosave=function(a){return q.dirty=!0,h.autosave(a)},q.content=m,q.closePreview(),q.$on("savework",function(a,b){var c=b;h.saveWorkConfirmation(q.origItem,q.item,q.dirty,c).then(function(a){g.setCurrentDeskId(null),n.url("/workspace/content"),o.setReferrerUrl("/workspace/content")})["finally"](function(){s.location.reload(!0)})}),q.$on("item:lock",function(a,b){q.item._id!==b.item||A||j.sessionId===b.lock_session||(h.lock(q.item,b.user),"view"!==q.action&&n.url(q.referrerUrl))}),q.$on("item:unlock",function(a,b){q.item._id!==b.item||A||j.sessionId===b.lock_session||(h.unlock(q.item,b.user),q._editable=q.item._editable=!1,q.origItem._locked=q.item._locked=!1,q.origItem.lock_session=q.item.lock_session=null,q.origItem.lock_user=q.item.lock_user=null,"view"!==q.action&&n.url(q.referrerUrl))}),q.$on("item:updated",function(a,b){b.item===q.origItem._id&&"view"===q.action&&z()}),q.$on("item:publish:wrong:format",function(a,b){b.item===q.item._id&&e.error(f("No formatters found for ")+b.formats.join(",")+" while publishing item having story name "+b.unique_name)}),p.setupShortcuts(q)}}}function l(){return{templateUrl:"scripts/superdesk-authoring/views/authoring-topbar.html"}}function m(){return{templateUrl:"scripts/superdesk-authoring/views/authoring-sidebar.html"}}function n(){return{link:function(a,b){var c=b.parent(),d=c.parent().width(),e=parseInt(b.css("margin-left"),10)+parseInt(b.css("margin-right"),10),f=c.outerWidth()+b.outerWidth()+e;d>f&&c.outerWidth(f)}}}function o(){return{scope:{item:"=",limit:"=",html:"@"},template:'<span class="char-count" ng-class="{error: numChars > limit}" translate>{{numChars}}/{{ limit }} characters </span>',link:function(a,b,c){a.html=a.html||!1,a.numChars=0,a.$watch("item",function(){var b=a.item||"";b=a.html?A(b):b,a.numChars=b.length||0})}}}function p(){return{scope:{item:"=",html:"@"},template:'<span class="char-count">{{numWords}} <span translate>words</span></span>',link:function(a,b,c){a.html=a.html||!1,a.numWords=0,a.$watch("item",function(){var b=a.item||"";b=a.html?A(b):b,a.numWords=_.compact(b.split(/\s+/)).length||0})}}}function q(a,b){var c={},d="editor:theme",e="default-normal";return c.availableThemes=[{cssClass:"",label:"Default Theme normal",key:"default-normal"},{cssClass:"large-text",label:"Default Theme large",key:"default-large"},{cssClass:"dark-theme",label:"Dark Theme normal",key:"dark-normal"},{cssClass:"dark-theme large-text",label:"Dark Theme large",key:"dark-large"},{cssClass:"natural-theme",label:"Natural Theme normal",key:"natural-normal"},{cssClass:"natural-theme large-text",label:"Natural Theme large",key:"natural-large"},{cssClass:"dark-theme-mono",label:"Dark Theme monospace",key:"dark-mono"}],c.save=function(a,c){return b.get().then(function(e){return e[d][a]=c.key,b.update(e)})},c.get=function(a){return b.get().then(function(b){var f=b[d]&&b[d][a]?b[d][a]:e;return _.find(c.availableThemes,{key:f})})},c}function r(a){return{templateUrl:"scripts/superdesk-authoring/views/theme-select.html",scope:{key:"@"},link:function(b,c){function d(){c.closest(".page-content-container").children(".theme-container").attr("class",e).addClass(b.theme&&b.theme.cssClass)}var e="main-article theme-container";b.themes=a.availableThemes,a.get(b.key).then(function(a){b.theme=a,d()}),b.changeTheme=function(c){b.theme=c,a.save(b.key,c),d()}}}}function s(a,b,c,d,e,f,g,h,i,j,k,l){return{scope:{item:"=",view:"=",_beforeSend:"=beforeSend",mode:"@"},templateUrl:"scripts/superdesk-authoring/views/send-item.html",link:function(m,n,o){function p(a,b){a!==b&&(m.isActive=!!a,m.item=m.isActive?{}:null,m.config=a,r())}function q(a){m.isActive=!!a,r()}function r(){m.isActive&&c.initialize().then(y).then(z).then(A)}function s(a){var b=m.selectedDesk._id,c=m.selectedStage._id||m.selectedDesk.incoming_stage;return"authoring"===m.mode?v(b,c,m.selectedMacro):"archive"===m.mode?w(b,c,m.selectedMacro,a):m.config?m.config.resolve({desk:b,stage:c,macro:m.selectedMacro?m.selectedMacro.name:null}):"ingest"===m.mode?x(b,c,m.selectedMacro,a):void 0}function t(){var a=m.selectedDesk._id,b=m.selectedStage._id||m.selectedDesk.incoming_stage,e=c.getCurrentDeskId();return m.item.more_coming=!0,v(a,b,m.selectedMacro,!0).then(function(){return i.linkItem(m.item,null,e)}).then(function(a){d.success(gettext("New take created.")),f.url("/authoring/"+a._id)},function(a){d.error(gettext("Failed to send and continue."))})}function u(b,c){return c?g.call(c,b,!0):a.when(b)}function v(c,f,g,h){var i;return h&&(i=a.defer()),u(m.item,g).then(function(a){b.find("tasks",m.item._id).then(function(a){return m.task=a,m.beforeSend()}).then(function(a){return a&&a._etag&&(m.task._etag=a._etag),b.save("move",{},{task:{desk:c,stage:f}},m.item)}).then(function(a){return d.success(gettext("Item sent.")),h?i.resolve():void e.close()},function(a){return a.data._issues["validator exception"]&&d.error(a.data._issues["validator exception"]),h?i.reject(a):void 0})}),h?i.promise:void 0}function w(a,c,e,g){var i;b.save("duplicate",{},{desk:m.item.task.desk},m.item).then(function(a){return b.find("archive",a._id)}).then(function(a){return u(a,e)}).then(function(a){return i=a,b.find("tasks",a._id)}).then(function(d){m.task=d,b.save("tasks",m.task,{task:_.extend(m.task.task,{desk:a,stage:c})})}).then(function(){d.success(gettext("Item sent.")),m.close(),g?f.url("/authoring/"+i._id):h.$broadcast("item:fetch")})}function x(a,b,c,e){return j.oneAs(m.item,{desk:a,stage:b,macro:c?c.name:c}).then(function(a){d.success(gettext("Item fetched.")),e?f.url("/authoring/"+a._id):h.$broadcast("item:fetch")})}function y(){var a=c.initialize().then(function(){m.desks=c.desks});return a="ingest"===m.mode?a.then(function(){m.selectDesk(c.getCurrentDesk())}):a.then(function(){var a=c.getItemDesk(m.item);a?m.selectDesk(a):m.selectDesk(c.getCurrentDesk())})}function z(){m.selectedDesk&&(m.stages=c.deskStages[m.selectedDesk._id],m.selectedStage=_.find(m.stages,{_id:m.selectedDesk.incoming_stage}))}function A(){null!=m.selectedDesk&&g.getByDesk(m.selectedDesk.name).then(function(a){m.macros=a})}m.mode=m.mode||"authoring",m.desks=null,m.stages=null,m.macros=null,m.task=null,m.selectedDesk=null,m.selectedStage=null,m.selectedMacro=null,m.beforeSend=m._beforeSend||a.when,m.$watch("item",q),m.$watch(j.getConfig,p),m.close=function(){m.$parent.views?m.$parent.views.send=!1:m.item=null,f.search("fetch",null),m.config&&m.config.reject()},m.selectDesk=function(a){m.selectedDesk=_.cloneDeep(a),m.selectedStage=null,z(),A()},m.selectStage=function(a){m.selectedStage=a},m.selectMacro=function(a){m.selectedMacro===a?m.selectedMacro=null:m.selectedMacro=a},m.send=function(a){var b=k.countErrors();return b>0?void l.confirmSpellcheck(b).then(angular.bind(this,function(){return s(a)}),function(a){return!1}):s(a)},m.canSendAndContinue=function(){return!i.isPublished(m.item)&&_.contains(["text","preformatted"],m.item.type)},m.sendAndContinue=function(){if(m.item&&m.item.publish_schedule)return void d.error(gettext("Takes cannot be scheduled."));var a=k.countErrors();return a>0?void l.confirmSpellcheck(a).then(angular.bind(this,function(){return t()}),function(a){return!1}):t()}}}}function t(a,b,c,d,e,f,g,h,i){return{templateUrl:"scripts/superdesk-authoring/views/article-edit.html",link:function(a){var d=4/3;a.limits=b.limits,a.toggleDetails=!0,a.errorMessage=null,a.$watch("item",function(a){angular.isDefined(a)&&(a._datelinedate="",angular.isDefined(a.dateline.located)&&!_.isNull(a.dateline.located)&&(a._datelinedate=e("formatDatelinesDate")(a.dateline.located,a.dateline.date)))}),c.initialize().then(function(){a.metadata=c.values}),a.updateDateline=function(b,c){""===c?(b.dateline.located=null,b.dateline.text="",b._datelinedate=""):(b._datelinedate=e("formatDatelinesDate")(b.dateline.located,a.origItem.dateline.date),b.dateline.text=e("previewDateline")(b.dateline.located,a.origItem.dateline.source,a.origItem.dateline.date))},a.evalAspectRatio=function(b){var c=b.split("-").map(_.partial(parseInt,_,10)),e=c[0]/c[1];return isNaN(e)||!isFinite(e)?(a.errorMessage="Error: Given Aspect ratio was not valid, using default: "+d,d):(a.errorMessage=null,e)},a.editCrop=function(b){a.toggleDetails=!a.toggleDetails,a.item.cropsize=b,a.item.aspectR=a.evalAspectRatio(b.name),null!=a.errorMessage&&h.error(i(a.errorMessage)),g.intent("edit","crop",a.item)}}}}function u(a){function b(){var a=this;this.state={},this.edit=function(b,c){a.item=b||null,a.state.opened=!!a.item,a.item&&(a.item.lockIt=!!c)}}return{controller:b,controllerAs:"authoring",templateUrl:"scripts/superdesk-authoring/views/authoring-container.html",scope:{},link:function(b){b.$watch(a.getItem,function(c,d){c!==d&&b.authoring.edit(c,!a.readonly)})}}}function v(a){return{templateUrl:"scripts/superdesk-authoring/views/authoring.html",require:"^sdAuthoringContainer",scope:{listItem:"=item"},link:function(b,c,d,e){b.$watch("listItem",function(a){a&&a.lockIt?b.lock():(b.origItem=null,b.$applyAsync(function(){b.origItem=a,b.action="view"}))}),b.lock=function(){b.origItem=null,a.open(b.listItem._id).then(function(a){b.origItem=a,b.action="edit"})}}}}function w(a,b,c,d){return{templateUrl:"scripts/superdesk-authoring/views/header-info.html",require:"^sdAuthoringWidgets",link:function(e,f,g,h){e.$watch("item",function(f){if(f&&(e.loaded=!0,!d.isLegal(e.item))){a.fetchItems(e.item.family_id||e.item._id,e.item).then(function(a){e.relatedItems=a});var g=_.filter(b,function(a){return"related-item"===a._id});e.activateWidget=function(){h.activate(g[0])},e.sliderUpdate=function(a,b){var d={};angular.isDefined(a)?d[b]=a.name:d[b]=null,_.extend(e.item,d),c.autosave(e.item)}}})}}}function x(a,b,c){function d(a){return b.find("archive",a)}function e(){a.search().edit&&d(a.search().edit).then(f.edit),a.search().view&&d(a.search().view).then(f.view)}this.item=null,this.readonly=!1;var f=this;this.edit=function(b){f.item=b,f.readonly=!1,c.flags.authoring=!!b,a.search("edit",b?b._id:null)},this.view=function(b){f.item=b,f.readonly=!0,c.flags.authoring=!!b,a.search("view",b?b._id:null)},this.close=function(){f.item=null,f.readonly=null,c.flags.authoring=!1,a.search("edit",null),a.search("view",null)},this.getItem=function(){return f.item},e()}var y=Object.freeze({headline:"",slugline:"",body_html:null,"abstract":null,anpa_take_key:null,byline:null,urgency:null,priority:null,subject:[],anpa_category:[],genre:[],groups:[],usageterms:null,ednote:null,place:[],located:null,dateline:null,language:null,unique_name:"",keywords:[],description:null,sign_off:null,publish_schedule:null,marked_for_not_publication:!1,pubstatus:null,more_coming:!1,targeted_for:[]}),z=Object.freeze({publish:!1,correct:!1,kill:!1,deschedule:!1,new_take:!1,re_write:!1,save:!1,edit:!1,mark_item:!1,duplicate:!1,copy:!1,view:!0,spike:!1,unspike:!1,package_item:!1,multi_edit:!1,send:!1});d.$inject=["$q","$timeout","api"],e.$inject=["$q","api","lock","autosave","confirm","privileges","desks"],f.$inject=["$q","api","session","privileges","notify"],g.$inject=["$window","$q","$filter","api","modal","gettext","$interpolate"],h.$inject=["urls","$http"],i.$inject=["$scope","cropImage","gettext","notify","$route"],j.$inject=["$scope","item","action","superdesk"],k.$inject=["superdesk","authoringWorkspace","notify","gettext","desks","authoring","api","session","lock","privileges","content","$location","referrer","macros","$timeout","$q","$window","modal"];var A=function(a){return a.replace(/<br[^>]*>/gi,"&nbsp;").replace(/<\/?[^>]+><\/?[^>]+>/gi," ").replace(/<\/?[^>]+>/gi,"").trim().replace(/&nbsp;/g," ")};o.$inject=[],p.$inject=[],q.$inject=["storage","preferencesService"],r.$inject=["authThemes"],s.$inject=["$q","api","desks","notify","authoringWorkspace","$location","macros","$rootScope","authoring","send","spellcheck","confirm"],t.$inject=["autosave","authoring","metadata","session","$filter","$timeout","superdesk","notify","gettext"],angular.module("superdesk.authoring",["superdesk.menu","superdesk.editor","superdesk.activity","superdesk.authoring.widgets","superdesk.authoring.metadata","superdesk.authoring.comments","superdesk.authoring.versioning","superdesk.authoring.versioning.versions","superdesk.authoring.versioning.history","superdesk.authoring.workqueue","superdesk.authoring.packages","superdesk.authoring.find-replace","superdesk.authoring.macros","superdesk.desks"]).service("authoring",e).service("autosave",d).service("confirm",g).service("lock",f).service("authThemes",q).service("cropImage",h).service("authoringWorkspace",x).directive("sdDashboardCard",n).directive("sdSendItem",s).directive("sdCharacterCount",o).directive("sdWordCount",p).directive("sdThemeSelect",r).directive("sdArticleEdit",t).directive("sdAuthoring",k).directive("sdAuthoringTopbar",l).directive("sdAuthoringSidebar",m).directive("sdAuthoringContainer",u).directive("sdAuthoringEmbedded",v).directive("sdHeaderInfo",w).config(["superdeskProvider",function(a){a.activity("authoring",{category:"/authoring",href:"/authoring/:_id",when:"/authoring/:_id",label:gettext("Authoring"),templateUrl:"scripts/superdesk-authoring/views/authoring.html",topTemplateUrl:"scripts/superdesk-dashboard/views/workspace-topnav.html",sideTemplateUrl:"scripts/superdesk-workspace/views/workspace-sidenav.html",controller:j,filters:[{action:"author",type:"article"}],resolve:{item:["$route","authoring",function(a,b){return b.open(a.current.params._id,!1)}],action:[function(){return"edit"}]},authoring:!0}).activity("edit.text",{label:gettext("Edit item"),priority:10,icon:"pencil",controller:["data","authoringWorkspace",function(a,b){b.edit(a.item)}],filters:[{action:"list",type:"archive"}],additionalCondition:["authoring","item",function(a,b){return a.itemActions(b).edit}]}).activity("kill.text",{label:gettext("Kill item"),priority:100,icon:"remove",group:"corrections",controller:["data","superdesk",function(a,b){b.intent("kill","content_article",a.item)}],filters:[{action:"list",type:"archive"}],additionalCondition:["authoring","item",function(a,b){return a.itemActions(b).kill}],privileges:{kill:1}}).activity("kill.content_article",{category:"/authoring",href:"/authoring/:_id/kill",when:"/authoring/:_id/kill",label:gettext("Authoring Kill"),templateUrl:"scripts/superdesk-authoring/views/authoring.html",topTemplateUrl:"scripts/superdesk-dashboard/views/workspace-topnav.html",sideTemplateUrl:"scripts/superdesk-workspace/views/workspace-sidenav.html",controller:j,filters:[{action:"kill",type:"content_article"}],resolve:{item:["$route","authoring",function(a,b){return b.open(a.current.params._id,!1)}],action:[function(){return"kill"}]},authoring:!0}).activity("correct.text",{label:gettext("Correct item"),priority:100,icon:"pencil",group:"corrections",controller:["data","superdesk",function(a,b){b.intent("correct","content_article",a.item)}],filters:[{action:"list",type:"archive"}],additionalCondition:["authoring","item",function(a,b){return a.itemActions(b).correct}],privileges:{correct:1}}).activity("correct.content_article",{category:"/authoring",href:"/authoring/:_id/correct",when:"/authoring/:_id/correct",label:gettext("Authoring Correct"),templateUrl:"scripts/superdesk-authoring/views/authoring.html",topTemplateUrl:"scripts/superdesk-dashboard/views/workspace-topnav.html",sideTemplateUrl:"scripts/superdesk-workspace/views/workspace-sidenav.html",controller:j,filters:[{action:"correct",type:"content_article"}],resolve:{item:["$route","authoring",function(a,b){return b.open(a.current.params._id,!1)}],action:[function(){return"correct"}]},authoring:!0}).activity("view.text",{label:gettext("View item"),priority:2e3,icon:"fullscreen",controller:["data","authoringWorkspace",function(a,b){b.view(a.item)}],filters:[{action:"list",type:"archive"},{action:"list",type:"legal_archive"}],condition:function(a){return"composite"!==a.type}}).activity("read_only.content_article",{category:"/authoring",href:"/authoring/:_id/view/:_type",when:"/authoring/:_id/view/:_type",label:gettext("Authoring Read Only"),templateUrl:"scripts/superdesk-authoring/views/authoring.html",topTemplateUrl:"scripts/superdesk-dashboard/views/workspace-topnav.html",sideTemplateUrl:"scripts/superdesk-workspace/views/workspace-sidenav.html",controller:j,filters:[{action:"read_only",type:"content_article"}],resolve:{item:["$route","authoring",function(a,b){return b.open(a.current.params._id,!0,a.current.params._type)}],action:[function(){return"view"}]},authoring:!0}).activity("edit.crop",{label:gettext("EDIT CROP"),modal:!0,cssClass:"upload-avatar modal-static modal-responsive",controller:i,templateUrl:"scripts/superdesk-authoring/views/change-image.html",filters:[{action:"edit",type:"crop"}]})}]).config(["apiProvider",function(a){a.api("move",{type:"http",backend:{rel:"move"}})}]),u.$inject=["authoringWorkspace"],v.$inject=["authoring"],w.$inject=["familyService","authoringWidgets","authoring","archiveService"],x.$inject=["$location","api","superdeskFlags"]}(),function(){"use strict";function a(){var a=[];this.widget=function(b,c){a.push(angular.extend({},c,{_id:b}))},this.$get=function(){return a}}function b(a,b,c,d){a.active=null,a.$watch("item",function(b){if(!b)return void(a.widgets=null);var e;e=d.isLegal(b)?"legalArchive":"composite"===b.type?"packages":"authoring",a.widgets=c.filter(function(a){return!!a.display[e]})}),a.isLocked=function(b){return b.needUnlock&&a.item._locked||b.needEditable&&!a.item._editable},a.activate=function(b){a.isLocked(b)||(a.active=a.active===b?null:b)},this.activate=function(b){a.activate(b)},a.closeWidget=function(b){a.active=null},angular.forEach(a.widgets,function(c){b[c._id]&&a.activate(c)}),a.$watch("item._locked",function(){if(a.active){var b=a.active;a.closeWidget(b),a.activate(b)}})}function c(){return{controller:b,templateUrl:"scripts/superdesk-authoring/widgets/views/authoring-widgets.html",transclude:!0}}b.$inject=["$scope","$routeParams","authoringWidgets","archiveService"],angular.module("superdesk.authoring.widgets",[]).provider("authoringWidgets",a).directive("sdAuthoringWidgets",c)}(),function(){"use strict";function a(a){this.comments=null,this.fetch=function(b){var c={where:{item:b},embedded:{user:1}};return a.item_comments.query(c).then(angular.bind(this,function(a){this.comments=a._items}))},this.save=function(b){return a.item_comments.save(b)}}function b(a,b,c,e,f){function g(){a.item&&c.fetch(a.item._id).then(function(){a.comments=c.comments})}function h(){a.active=b.comments||null}a.text=null,a.saveEnterFlag=!1,a.$watch("item._id",g),a.users=[],a.saveOnEnter=function(b){a.saveEnterFlag&&b.keyCode===d&&!b.shiftKey&&a.save()},a.save=function(){var b=a.text||"";b.length&&(a.text="",a.flags={saving:!0},c.save({text:b,item:a.item._id}).then(g))},a.cancel=function(){a.text=""},a.$on("item:comment",function(b,c){c.item===a.item.guid&&g()}),a.$on("$locationChangeSuccess",h),h()}function c(a){return{scope:{comment:"="},link:function(b,c,d){var e;e=d.text.replace(/(?:\r\n|\r|\n)/g,"</p><p>");var f=e.match(/\@([a-zA-Z0-9-_.]\w+)/g);_.each(f,function(a){var c=a.substring(1,a.length);b.comment.mentioned_users&&b.comment.mentioned_users[c]&&(e=e.replace(a,'<i sd-user-info data-user="'+b.comment.mentioned_users[c]+'">'+a+"</i>"))}),c.html("<p><b>"+d.name+"</b> : "+e+"</p>"),a(c.contents())(b)}}}var d=13;a.$inject=["api"],b.$inject=["$scope","$routeParams","commentsService","api","$q"],c.$inject=["$compile"],angular.module("superdesk.authoring.comments",["superdesk.authoring.widgets","mentio","superdesk.api"]).config(["authoringWidgetsProvider",function(a){a.widget("comments",{icon:"comments",label:gettext("Comments"),template:"scripts/superdesk-authoring/comments/views/comments-widget.html",order:3,side:"right",display:{authoring:!0,packages:!0,legalArchive:!1}})}]).config(["apiProvider",function(a){a.api("item_comments",{type:"http",backend:{rel:"item_comments"}})}]).controller("CommentsWidgetCtrl",b).service("commentsService",a).directive("sdCommentText",c)}(),function(){"use strict";angular.module("superdesk.authoring.versioning",[]).config(["authoringWidgetsProvider",function(a){a.widget("versioning",{icon:"revision",label:gettext("Versioning"),removeHeader:!0,template:"scripts/superdesk-authoring/versioning/views/versioning.html",order:4,side:"right",display:{authoring:!0,packages:!0,legalArchive:!0}})}])}(),function(){"use strict";function a(a,b,c,d,e,f,g){function h(){f.initialize().then(function(){a.desks=f.desks,a.stages=f.deskStages,a.users=f.users,g.getVersionHistory(a.item,f,"versions").then(function(c){a.versions=c,a.last=g.lastVersion(a.item,a.versions),g.isLegal(a.item)?(a.canRevert=!1,a.openVersion(a.last)):(a.canRevert=b.isEditable(a.item)&&!b.isPublished(a.item),a.item._autosave?a.selected=a.item._autosave:a.openVersion(a.last))})})}a.last=null,a.versions=null,a.selected=null,a.users=null,a.canRevert=!1,a.desks=null,a.stages=null,a.openAutosave=function(){a.selected=a.item._autosave,a.closePreview()},a.openVersion=function(b){a.selected=b,b!==a.last||a.item._autosave?a.preview(b):a.closePreview()},a.revert=function(b){a.$parent.revert(b).then(h)},a.$watchGroup(["item._id","item._latest_version"],h)}function b(){return{templateUrl:"scripts/superdesk-authoring/versioning/versions/views/versions.html"}}a.$inject=["$scope","authoring","api","notify","lock","desks","archiveService"],b.$inject=[],angular.module("superdesk.authoring.versioning.versions",[]).directive("sdVersioningVersion",b).controller("VersioningWidgetCtrl",a)}(),function(){"use strict";function a(a,b,c,d,e,f){function g(){e.initialize().then(function(){a.desks=e.desks,a.stages=e.deskStages,a.users=e.users,f.getVersionHistory(a.item,e,"operations").then(function(c){a.versions=c,a.last=f.lastVersion(a.item,a.versions),f.isLegal(a.item)?(a.canRevert=!1,a.openVersion(a.last)):(a.canRevert=b.isEditable(a.item)&&!b.isPublished(a.item),a.item._autosave?a.selected=a.item._autosave:a.openVersion(a.last))})})}a.last=null,a.versions=null,a.selected=null,a.users=null,a.desks=null,a.stages=null,a.openVersion=function(b){a.selected=b,b!==a.last||a.item._autosave?a.preview(b):a.closePreview()},a.$watchGroup(["item._id","item._latest_version"],g)}function b(){return{templateUrl:"scripts/superdesk-authoring/versioning/history/views/history.html"}}function c(a,b){return{templateUrl:"scripts/superdesk-authoring/versioning/history/views/publish_queue.html",scope:{item:"="},link:function(c){c.transmitted_item=null,c.show_transmission_details=!1,c.showFormattedItem=function(a){c.transmitted_item=a.formatted_item},c.hideFormattedItem=function(){c.transmitted_item=null},c.showOrHideTransmissionDetails=function(){if(c.show_transmission_details=!c.show_transmission_details,c.show_transmission_details){var d,e={item_id:c.item._id,item_version:c.item._current_version,max_results:20};d=b.isLegal(c.item)?a.legal_publish_queue.query(e):a.publish_queue.query(e),d.then(function(a){_.each(a._items,function(a){angular.isUndefined(a.completed_at)&&(a.completed_at=a._updated)}),c.queuedItems=a._items})}}}}}a.$inject=["$scope","authoring","api","notify","desks","archiveService"],b.$inject=[],c.$inject=["api","archiveService"],angular.module("superdesk.authoring.versioning.history",[]).directive("sdVersioningHistory",b).directive("sdTransmissionDetails",c).controller("HistoryWidgetCtrl",a)}(),function(){"use strict";function a(a,b,c,d,e,f){function g(b,c){b!==c&&(a.item.publish_schedule_date&&a.item.publish_schedule_time?a.item.publish_schedule=f.mergeDateTime(a.item.publish_schedule_date,a.item.publish_schedule_time).format():a.item.publish_schedule=null,a.autosave(a.item))}function h(){if(a.item.publish_schedule){var b=new Date(Date.parse(a.item.publish_schedule));a.item.publish_schedule_date=d("formatDateTimeString")(b,"MM/DD/YYYY"),a.item.publish_schedule_time=d("formatDateTimeString")(b,"HH:mm:ss")}}b.initialize().then(function(){a.deskLookup=b.deskLookup,a.userLookup=b.userLookup}),c.initialize().then(function(){a.metadata=c.values,
null!=a.item.related_to&&c.fetchAssociated(a.item.related_to).then(function(b){a.associatedItem=b})}),a.processGenre=function(){a.item.genre=_.map(a.item.genre,function(a){return _.pick(a,"name")})},a.$watch("item.publish_schedule_date",function(a,b){g(a,b)}),a.$watch("item.publish_schedule_time",function(a,b){g(a,b)}),a.disableAddingTargetedFor=function(){return!a.item._editable||angular.isUndefined(a.item.targeted_for_value)||""===a.item.targeted_for_value},a.addTargeted=function(){if(angular.isUndefined(a.item.targeted_for)&&(a.item.targeted_for=[]),!angular.isUndefined(a.item.targeted_for_value)&&""!==a.item.targeted_for_value){var b={name:a.item.targeted_for_value};angular.isUndefined(_.find(a.item.targeted_for,b))&&(b.allow=angular.isUndefined(a.item.negation)?!0:!a.item.negation,a.item.targeted_for.push(b),a.autosave(a.item))}},a.removeTargeted=function(b){angular.isDefined(_.find(a.item.targeted_for,b))&&(a.item.targeted_for=_.without(a.item.targeted_for,b),a.autosave(a.item))},a.unique_name_editable=Boolean(e.privileges.metadata_uniquename),h()}function b(){return{scope:{list:"=",disabled:"=ngDisabled",item:"=",field:"@",change:"&"},templateUrl:"scripts/superdesk-authoring/metadata/views/metadata-dropdown.html",link:function(a){a.select=function(b){var c={};angular.isDefined(b)?c[a.field]="place"===a.field?[b]:b.name:c[a.field]=null,_.extend(a.item,c),a.change({item:a.item})}}}}function c(){return{scope:{item:"=",field:"@",disabled:"=",list:"=",change:"&"},templateUrl:"scripts/superdesk-authoring/metadata/views/metadata-words-list.html",link:function(a){var b=13;a.selectTerm=function(c){if(c.keyCode===b&&""!==_.trim(a.term)){var d=_.clone(a.item[a.field])||[],e=_.findIndex(d,function(b){return b.toLowerCase()===a.term.toLowerCase()});if(0>e){d.push(_.trim(a.term));var f={};f[a.field]=d,_.extend(a.item,f),a.change({item:a.item})}a.term=""}},a.removeTerm=function(b){var c=_.without(a.item[a.field],b),d={};d[a.field]=c,_.extend(a.item,d),a.change({item:a.item})}}}}function d(){return{scope:{item:"=",field:"@",disabled:"=ngDisabled",list:"=",unique:"@",postprocessing:"&",change:"&",header:"@"},templateUrl:"scripts/superdesk-authoring/metadata/views/metadata-terms.html",link:function(a){a.$watch("list",function(b){if(b&&0!==b.length&&b[0].hasOwnProperty("parent")){var c={};angular.forEach(b,function(a){c.hasOwnProperty(a.parent)?c[a.parent].push(a):c[a.parent]=[a]}),a.tree=c,a.activeTree=c[null]}}),a.openParent=function(b,c){var d=_.find(a.list,{qcode:b.parent});a.openTree(d,c)},a.openTree=function(b,c){a.activeTerm=b,a.activeTree=a.tree[b?b.qcode:null],c.stopPropagation()},a.terms=a.list,a.activeList=!1,a.selectedTerm="";var b=a.unique||"qcode";a.searchTerms=function(c){return c?a.terms=_.filter(a.list,function(d){var e={};return e[b]=d[b],a.activeList=!0,-1!==d.name.toLowerCase().indexOf(c.toLowerCase())&&!_.find(a.item[a.field],e)}):(a.terms=a.list,a.activeList=!1),a.terms},a.selectTerm=function(b){if(b){var c=_.clone(a.item[a.field])||[];c.push(b);var d={};d[a.field]=c,_.extend(a.item,d),a.selectedTerm="",a.postprocessing(),a.change({item:a.item})}},a.removeTerm=function(b){var c={},d=a.item[a.field],e=_.without(d,b);d&&e.length===d.length&&_.remove(e,{name:b}),c[a.field]=e,_.extend(a.item,c),a.change({item:a.item})}}}}function e(){return{scope:{item:"=",fieldprefix:"@",field:"@",disabled:"=ngDisabled",list:"=",change:"&",postprocessing:"&",header:"@"},templateUrl:"scripts/superdesk-authoring/metadata/views/metadata-locators.html",link:function(a,b){a.locators=a.list,a.selectedTerm="",a.$watch("item",function(b){angular.isDefined(b)&&(angular.isDefined(a.fieldprefix)&&angular.isDefined(b[a.fieldprefix][a.field])&&!_.isNull(b[a.fieldprefix][a.field])?a.selectedTerm=b[a.fieldprefix][a.field].city:angular.isDefined(b[a.field])&&!_.isNull(b[a.field])&&(a.selectedTerm=b[a.field].city))}),a.searchLocator=function(b){return b?a.locators=_.filter(a.list,function(a){return-1!==a.city.toLowerCase().indexOf(b.toLowerCase())}):a.locators=a.list,a.selectedTerm=b,a.selectLocator(null,!1),a.locators},a.selectLocator=function(b,c){var d={};b?a.selectedTerm=b.city:b={city:a.selectedTerm,city_code:a.selectedTerm,tz:"UTC",dateline:"city",country:"",country_code:"",state_code:"",state:""},angular.isDefined(a.fieldprefix)?(d[a.fieldprefix]={},d[a.fieldprefix][a.field]=b):d[a.field]=b,_.extend(a.item,d);var e={item:a.item,city:a.selectedTerm};a.postprocessing(e),(angular.isUndefined(c)||c)&&a.change(e)}}}}function f(a,b){var c={values:{},subjectScope:null,loaded:null,fetchMetadataValues:function(){var b=this;return a("vocabularies").query().then(function(a){_.each(a._items,function(a){b.values[a._id]=a.items}),b.values.targeted_for=_.union(b.values.geographical_restrictions,b.values.subscriber_types)})},fetchSubjectcodes:function(b){var c=this;return a.get("/subjectcodes").then(function(a){c.values.subjectcodes=a._items})},fetchAssociated:function(b){return null!=b?a("archive").getById(b).then(function(a){return a}):void 0},removeSubjectTerm:function(a){var b=this,c={},d=b.subjectScope.item[b.subjectScope.field],e=_.without(d,a);e.length===d.length&&_.remove(e,{name:a}),c[b.subjectScope.field]=e,_.extend(b.subjectScope.item,c),b.subjectScope.change({item:b.subjectScope.item})},fetchCities:function(){var b=this;return a.get("/cities").then(function(a){b.values.cities=a._items})},initialize:function(){return this.loaded||(this.loaded=this.fetchMetadataValues().then(angular.bind(this,this.fetchSubjectcodes)).then(angular.bind(this,this.fetchCities))),this.loaded}};return c}a.$inject=["$scope","desks","metadata","$filter","privileges","datetimeHelper"],b.$inject=[],c.$inject=[],d.$inject=[],e.$inject=[],f.$inject=["api","$q"],angular.module("superdesk.authoring.metadata",["superdesk.authoring.widgets"]).config(["authoringWidgetsProvider",function(a){a.widget("metadata",{icon:"info",label:gettext("Info"),template:"scripts/superdesk-authoring/metadata/views/metadata-widget.html",order:1,side:"right",display:{authoring:!0,packages:!0,legalArchive:!0}})}]).controller("MetadataWidgetCtrl",a).service("metadata",f).directive("sdMetaTerms",d).directive("sdMetaDropdown",b).directive("sdMetaWordsList",c).directive("sdMetaLocators",e)}(),function(){"use strict";function a(a,b){this.items=[],this.fetch=function(){return a.getIdentity().then(angular.bind(this,function(a){return b.query("archive",{source:{filter:{term:{lock_user:a._id}}}}).then(angular.bind(this,function(a){return this.items=null,this.items=a._items||[],this.items}))}))},this.updateItem=function(a){var c=_.find(this.items,{_id:a});return c?b.find("archive",a).then(function(a){return angular.extend(c,a)}):void 0}}function b(a,b,c,d,e,f){function g(){c.fetch().then(function(){var d=b.current||{_id:null,params:{}};a.isMultiedit="multiedit"===d._id,a.active=null,d.params.edit&&(a.active=_.find(c.items,{_id:d.params.edit}))})}a.active=null,a.workqueue=c,a.multiEdit=d,a.$on("item:lock",g),a.$on("item:unlock",g),a.$on("media_archive",function(a,b){c.updateItem(b.item)}),g(),a.openDashboard=function(){e.intent("author","dashboard")},a.closeItem=function(a){f.unlock(a).then(g)},a.openMulti=function(){d.open()},a.closeMulti=function(){d.exit()}}function c(a,b){return{templateUrl:"scripts/superdesk-authoring/views/opened-articles.html",controller:"Workqueue",scope:!0,link:function(c){c.edit=function(a,d){d.ctrlKey||(c.active=a,b.edit(a),d.preventDefault())},c.link=function(b){return b?"composite"===b.type?a.link("edit.package",b):a.link("edit.text",b):void 0}}}}function d(){return{templateUrl:"scripts/superdesk-authoring/views/dashboard-articles.html",controller:"Workqueue"}}a.$inject=["session","api"],b.$inject=["$scope","$route","workqueue","multiEdit","superdesk","lock"],c.$inject=["$rootScope","authoringWorkspace"],angular.module("superdesk.authoring.workqueue",["superdesk.activity","superdesk.notification","superdesk.authoring.multiedit"]).service("workqueue",a).controller("Workqueue",b).directive("sdWorkqueue",c).directive("sdDashboardArticles",d)}(),function(){"use strict";function a(a,b,c,d,e){function f(){var c=e.query(b.search()),f=[];_.forEach(a.item.linked_in_packages,function(a){f.push(a["package"])}),c.size(25).filter({terms:{guid:f}}),d.archive.query(c.getCriteria(!0)).then(function(b){a.contentItems=b._items})}a.contentItems=[],a.item&&a.item.linked_in_packages&&a.item.linked_in_packages.length>0&&f()}return a.$inject=["$scope","$location","superdesk","api","search"],angular.module("superdesk.authoring.packages",["superdesk.authoring.widgets"]).config(["authoringWidgetsProvider",function(a){a.widget("packages",{icon:"package",label:gettext("Packages"),template:"scripts/superdesk-authoring/packages/views/packages-widget.html",order:5,side:"right",display:{authoring:!0,packages:!0,legalArchive:!1}})}]).controller("PackagesWidgetCtrl",a)}(),function(){"use strict";function a(a,b,c){return{link:function(a,b){a.to="",a.from="",a.next=function(){c.selectNext()},a.prev=function(){c.selectPrev()},a.replace=function(){c.replace(a.to||""),c.selectNext()},a.replaceAll=function(){c.replaceAll(a.to||"")},a.$watch("from",function(a){var b=document.getElementById("find-replace-what"),d=b.selectionStart,e=b.selectionEnd;c.setSettings({findreplace:{needle:a}}),c.render(),c.selectNext(),b.setSelectionRange(d,e)}),a.$on("$destroy",function(){c.setSettings({findreplace:null}),c.render()})}}}a.$inject=["$timeout","$rootScope","editor"],angular.module("superdesk.authoring.find-replace",["superdesk.editor","superdesk.authoring.widgets"]).directive("sdFindReplace",a).config(["authoringWidgetsProvider",function(a){a.widget("find-replace",{icon:"find-replace",label:gettext("Find and Replace"),template:"scripts/superdesk-authoring/editor/views/find-replace.html",order:2,side:"right",needUnlock:!0,display:{authoring:!0,packages:!1,legalArchive:!1}})}])}(),function(){"use strict";function a(a,b){function c(a){return{article:a}}var d=2,e="multiedit",f=a.getItem(e);this.items=null===f?[]:f,this.minBoards=function(){return d},this.create=function(a){var b=this;if(b.items=[],a&&_.each(a,function(a){b.items.push(c(a))}),b.items.length<d)for(var e=0;e<d-b.items.length;e++)b.items.push(c(null));b.updateItems(),b.open()},this.exit=function(a){this.items=[],this.updateItems(),b.intent("author","dashboard")},this.open=function(){b.intent("author","multiedit")},this.updateItems=function(){a.setItem(e,this.items)},this.edit=function(a,b){this.items[b]?this.items[b].article=a:this.items[b]=c(a),this.updateItems()},this.remove=function(a){_.extend(_.find(this.items,{article:a}),{article:null}),this.updateItems()},this.close=function(a){this.items.length>d&&(this.items.splice(a,1),this.updateItems())}}function b(a,b){a.$watch(function(){return b.items},function(b){a.boards=b}),a.minBoards=b.minBoards(),a.closeBoard=function(a){b.close(a)}}function c(a,b,c){return{templateUrl:"scripts/superdesk-authoring/multiedit/views/sd-multiedit-dropdown.html",link:function(d){d.current=c.current.params._id,d.queue=[d.current],d.$watch(function(){return a.items},function(a){d.items=a}),d.toggle=function(a){return a===d.current?!1:void(d.selected(a)?d.queue=_.without(d.queue,a):d.queue.push(a))},d.selected=function(a){return-1!==_.indexOf(d.queue,a)},d.open=function(){b.create(d.queue)}}}}function d(a,b){return{templateUrl:"scripts/superdesk-authoring/multiedit/views/sd-multiedit-inner-dropdown.html",link:function(c,d,e){function f(){c.items=_.filter(g,function(a){return-1===_.indexOf(h,a._id)})}var g=[],h=[];c.$watch(function(){return b.items},function(a){h=_.map(b.items,function(a){return a.article}),f()},!0),c.$watch(function(){return a.items},function(a){g=a,f()}),c.open=function(a){b.edit(a,e.board)}}}}function e(a,b,c){return{templateUrl:"scripts/superdesk-authoring/multiedit/views/sd-multiedit-article.html",scope:{article:"=",focus:"="},link:function(d,e){function f(){a.open(d.article).then(function(b){d.origItem=b,d.item=_.create(b),d._editable=a.isEditable(b),d.isMediaType=_.contains(["audio","video","picture"],d.item.type),d.focus&&c(function(){e.children().focus()},0,!1)})}d.$watch("article",function(a,b){a&&a!==b&&f()}),f(),d.autosave=function(b){d.dirty=!0,a.autosave(b)},d.save=function(b,c){return a.save(d.origItem,b).then(function(a){return c&&c.$setPristine(),a})},d.remove=function(a){b.remove(a._id)}}}}function f(a){return{link:function(b,c){function d(){f=!1,$("#multiedit-float").hide()}function e(b,c){var d=a.height(),e=a.width(),f={right:e-b};return 400>d-c?(f.bottom=d-c,f.top="auto"):(f.top=c,f.bottom="auto"),f}var f=!1;c.bind("click",function(a){f?$("#multiedit-float").hide():(a.preventDefault(),a.stopPropagation(),$("#multiedit-float").css(e(a.pageX,a.pageY)).show()),f=!f}),a.bind("click",d),b.$on("$destroy",function(){a.unbind("click",d)})}}}a.$inject=["storage","superdesk"],b.$inject=["$scope","multiEdit"],c.$inject=["workqueue","multiEdit","$route"],d.$inject=["workqueue","multiEdit"],e.$inject=["authoring","multiEdit","$timeout"],f.$inject=["$document"],angular.module("superdesk.authoring.multiedit",["superdesk.activity","superdesk.authoring"]).service("multiEdit",a).directive("sdMultieditDropdown",c).directive("sdMultieditInnerDropdown",d).directive("sdMultieditArticle",e).directive("sdMultieditFloatMenu",f).config(["superdeskProvider",function(a){a.activity("multiedit",{category:"/authoring",href:"/multiedit",when:"/multiedit",label:gettext("Authoring"),templateUrl:"scripts/superdesk-authoring/multiedit/views/multiedit.html",topTemplateUrl:"scripts/superdesk-dashboard/views/workspace-topnav.html",sideTemplateUrl:"scripts/superdesk-workspace/views/workspace-sidenav.html",controller:b,filters:[{action:"author",type:"multiedit"}]})}])}(),function(){"use strict";function a(a,b,c){function d(d,e,f){return a.save("macros",{macro:d.name,item:_.omit(e),commit:!!f}).then(function(a){return angular.extend(e,a.item),f||b.save(e),e},function(a){angular.isDefined(a.data._message)&&c.error(gettext("Error: "+a.data._message))})}this.get=function(){return a.query("macros").then(angular.bind(this,function(a){return this.macros=a._items,this.macros}))},this.getByDesk=function(b){return a.query("macros",{desk:b}).then(angular.bind(this,function(a){return this.macros=a._items,this.macros}))},this.setupShortcuts=function(a){this.get().then(function(b){angular.forEach(b,function(b){b.shortcut&&a.$on("key:ctrl:"+b.shortcut,function(){d(b,a.item)})})})},this.call=d}function b(a,b,c){b.get().then(function(){var d=c.getCurrentDeskId();null!==d?b.getByDesk(c.getCurrentDesk().name).then(function(b){a.macros=b}):a.macros=b.macros}),a.call=function(c){return b.call(c,a.item)}}a.$inject=["api","autosave","notify"],b.$inject=["$scope","macros","desks"],angular.module("superdesk.authoring.macros",[]).service("macros",a).controller("Macros",b).config(["authoringWidgetsProvider",function(a){a.widget("macros",{icon:"macros",label:gettext("Macros"),template:"scripts/superdesk-authoring/macros/views/macros-widget.html",order:6,side:"right",display:{authoring:!0,packages:!0,legalArchive:!1}})}])}(),function(){"use strict";function a(a,b){function c(){var b=(a.search().sort||"versioncreated:desc").split(":");return angular.extend(_.find(h,{field:b[0]}),{dir:b[1]})}function d(a){var b=_.find(h,{field:a});f(b.field,b.defaultDir||"desc")}function e(){var a=c(),b="asc"===a.dir?"desc":"asc";f(a.field,b)}function f(b,c){a.search("sort",b+":"+c),a.search("page",null)}function g(a){function b(a,b){var c=b.page||1,d=e||Number(localStorage.getItem("pagesize"))||Number(b.max_results)||f;a.size=d,a.from=(c-1)*a.size}function d(a,b){if(a.beforefirstcreated||a.afterfirstcreated){var c={firstcreated:{}};a.beforefirstcreated&&(c.firstcreated.lte=a.beforefirstcreated),a.afterfirstcreated&&(c.firstcreated.gte=a.afterfirstcreated),b.post_filter({range:c})}if(a.beforeversioncreated||a.afterversioncreated){var d={versioncreated:{}};a.beforeversioncreated&&(d.versioncreated.lte=a.beforeversioncreated),a.afterversioncreated&&(d.versioncreated.gte=a.afterversioncreated),b.post_filter({range:d})}if(a.after){var e={firstcreated:{}};e.firstcreated.gte=a.after,b.post_filter({range:e})}if(a.type){var f={type:JSON.parse(a.type)};b.post_filter({terms:f})}a.urgency&&b.post_filter({terms:{urgency:JSON.parse(a.urgency)}}),a.source&&b.post_filter({terms:{source:JSON.parse(a.source)}}),a.category&&b.post_filter({terms:{"anpa_category.name":JSON.parse(a.category)}}),a.desk&&b.post_filter({terms:{"task.desk":JSON.parse(a.desk)}}),a.stage&&b.post_filter({terms:{"task.stage":JSON.parse(a.stage)}}),a.state&&b.post_filter({terms:{state:JSON.parse(a.state)}})}var e,f=25,g=[],h=[];null==a&&(a={}),this.getCriteria=function(d){var e=a,f=c(),i={query:{filtered:{filter:{and:g}}},sort:[_.zipObject([f.field],[f.dir])]};return h.length>0&&(i.post_filter={and:h}),b(i,e),e.q&&(i.query.filtered.query={query_string:{query:e.q,lenient:!1,default_operator:"AND"}}),d&&(i={source:i},e.repo&&(i.repo=e.repo)),i},this.filter=function(a){return g.push(a),this},this.post_filter=function(a){return h.push(a),this},this.size=function(a){return e=null!=a?a:e,this},a.spike?this.filter({term:{state:"spiked"}}):this.filter({not:{term:{state:"spiked"}}}),a.ignoreKilled&&this.filter({not:{term:{state:"killed"}}}),a.ignoreDigital&&this.filter({not:{term:{package_type:"takes"}}}),this.filter({not:{and:[{term:{_type:"published"}},{term:{package_type:"takes"}},{term:{last_published_version:!1}}]}}),this.filter({not:{and:[{term:{package_type:"takes"}},{term:{_type:"archive"}}]}}),d(a,this)}var h=[{field:"versioncreated",label:b("Updated")},{field:"firstcreated",label:b("Created")},{field:"urgency",label:b("News Value")},{field:"anpa_category.name",label:b("Category")},{field:"slugline",label:b("Slugline")},{field:"priority",label:b("Priority")}];this.getSubjectCodes=function(b,c){var d=b.selectedParameters,e=[];if(!a.search().q)return e;for(var f=0,g=d.length;g>f;f++){var h=d[f];if(-1!==h.indexOf("subject.name"))for(var i=h.substring(h.lastIndexOf("(")+1,h.lastIndexOf(")")),j=0,k=c.length;k>j;j++)c[j].name===i&&e.push(c[j])}return e},this.setSort=d,this.getSort=c,this.sortOptions=h,this.toggleSortDir=e,this.query=function(a){return new g(a)}}function b(a,b){function c(a){for(h.selectedParameters=[];a.indexOf(":")>0&&a.indexOf(":")<a.indexOf("(")&&a.indexOf(":")<a.indexOf(")");){var b=a.indexOf(":"),c=a.substring(a.lastIndexOf(" ",b),a.indexOf(")",b)+1);h.selectedParameters.push(c),a=a.replace(c,"")}return a}function d(a){for(h.selectedKeywords=[];a.indexOf("(")>=0;){var b=a.indexOf("("),c=a.substring(b,a.indexOf(")",b)+1);h.selectedKeywords.push(c),a=a.replace(c,"")}}function e(b,c){if(c.indexOf("Last")>=0)f();else{var d=a.search();if(d[b]){var e=JSON.parse(d[b]);e.splice(e.indexOf(c),1),e.length>0?a.search(b,JSON.stringify(e)):a.search(b,null)}}}function f(){var b=a.search();b.after&&a.search("after",null)}function g(){return b.initialize().then(function(e){h.selectedFacets={},h.selectedParameters=[],h.selectedKeywords=[],h.currentSearch=a.search();var f=h.currentSearch.q;if(f){var g=c(f);d(g)}return _.forEach(h.currentSearch,function(a,c){if("q"!==c)if(h.selectedFacets[c]=[],"desk"===c){var d=JSON.parse(a);_.forEach(d,function(a){h.selectedFacets[c].push(b.deskLookup[a].name)})}else if("stage"===c){var e=a;_.forEach(b.deskStages[b.getCurrentDeskId()],function(a){a._id===JSON.parse(e)[0]&&h.selectedFacets[c].push(a.name)})}else"after"===c?"now-24H"===a?h.selectedFacets.date=["Last Day"]:"now-1w"===a?h.selectedFacets.date=["Last Week"]:"now-1M"===a&&(h.selectedFacets.date=["Last Month"]):i[c]&&(h.selectedFacets[c]=JSON.parse(a))}),h})}var h={};h.selectedFacets={},h.selectedParameters=[],h.selectedKeywords=[],h.currentSearch={};var i={type:1,category:1,urgency:1,source:1,day:1,week:1,month:1,desk:1,stage:1,state:1};return{initSelectedFacets:g,removeFacet:e}}function c(a,b,c,d,e,f){function g(a,b){f.identity._id===b.user&&h()}function h(){var e=_.omit(b.search(),"_id");_.isEqual(_.omit(e,"page"),_.omit(i,"page"))||b.search("page",null);var f=d.query(b.search()).getCriteria(!0),g="search";f.repo&&(g=f.repo),a.repo.search&&("local"!==a.repo.search?g=a.repo.search:f.repo.indexOf(",")>=0&&(g="search")),c.query(g,f).then(function(b){a.items=b}),i=e}a.context="search",a.$on("item:deleted:archived",g),a.$on("item:published:no_post_publish_actions",g),a.repo={ingest:!0,archive:!0,published:!0,archived:!0};var i=_.omit(b.search(),"_id");a.$watch(function(){return _.omit(b.search(),"_id")},h,!0)}function d(a,b,c,d,e,f,g,h,i){this.send=function(){return d.all(b.getItems())},this.sendAs=function(){return d.allAs(b.getItems())},this.multiedit=function(){c.create(b.getIds()),c.open()},this.createPackage=function(){e.createPackageFromItems(b.getItems()).then(function(a){f.intent("author","package",a)},function(a){403===a.status&&a.data&&a.data._message&&g.error(gettext(a.data._message),3e3)})},this.spikeItems=function(){h.spikeMultiple(b.getItems()),a.$broadcast("item:spike"),b.reset()},this.unspikeItems=function(){h.unspikeMultiple(b.getItems()),a.$broadcast("item:unspike"),b.reset()},this.canSpikeItems=function(){var a=!0;return b.getItems().forEach(function(b){a=a&&i.itemActions(b).spike}),a}}a.$inject=["$location","gettext"],b.$inject=["$location","desks"],c.$inject=["$scope","$location","api","search","notify","session"],angular.module("superdesk.search",["superdesk.api","superdesk.desks","superdesk.activity","superdesk.list","superdesk.keyboard"]).service("search",a).service("tags",b).controller("MultiActionBar",d).filter("FacetLabels",function(){return function(a){return"URGENCY"===a.toUpperCase()?"News Value":a}}).directive("sdSearchFacets",["$location","desks","privileges","tags","asset",function(a,b,c,d,e){return b.initialize(),{require:"^sdSearchContainer",templateUrl:e.templateUrl("superdesk-search/views/search-facets.html"),scope:{items:"=",desk:"=",repo:"=",context:"="},link:function(e,f,g,h){e.flags=h.flags,e.sTab=!0,e.aggregations={},e.privileges=c.privileges;var i=function(){e.aggregations={type:{},desk:{},stage:{},date:{},source:{},category:{},urgency:{},state:{}}};e.$watch("items",function(){i(),d.initSelectedFacets().then(function(a){e.tags=a,e.items&&void 0!==e.items._aggregations&&(_.forEach(e.items._aggregations.type.buckets,function(a){e.aggregations.type[a.key]=a.doc_count}),_.forEach(e.items._aggregations.category.buckets,function(a){""!==a.key&&(e.aggregations.category[a.key]=a.doc_count)}),_.forEach(e.items._aggregations.urgency.buckets,function(a){e.aggregations.urgency[a.key]=a.doc_count}),_.forEach(e.items._aggregations.source.buckets,function(a){e.aggregations.source[a.key]=a.doc_count}),_.forEach(e.items._aggregations.state.buckets,function(a){e.aggregations.state[a.key]=a.doc_count}),_.forEach(e.items._aggregations.day.buckets,function(a){e.aggregations.date["Last Day"]=a.doc_count}),_.forEach(e.items._aggregations.week.buckets,function(a){e.aggregations.date["Last Week"]=a.doc_count}),_.forEach(e.items._aggregations.month.buckets,function(a){e.aggregations.date["Last Month"]=a.doc_count}),e.desk||_.forEach(e.items._aggregations.desk.buckets,function(a){var c=b.deskLookup[a.key];if("undefined"==typeof c){var d=["Desk (key: ",a.key,") not found in ","deskLookup, probable storage inconsistency."].join("");return void console.warn(d)}e.aggregations.desk[c.name]={count:a.doc_count,id:a.key}}),e.desk&&_.forEach(e.items._aggregations.stage.buckets,function(a){_.forEach(b.deskStages[e.desk._id],function(b){b._id===a.key&&(e.aggregations.stage[b.name]={count:a.doc_count,id:a.key})})}))})}),e.toggleFilter=function(a,b){e.hasFilter(a,b)?e.removeFilter(a,b):"date"===a?e.setDateFilter(b):e.setFilter(a,b)},e.removeFilter=function(a,b){d.removeFacet(a,b)},e.setFilter=function(b,c){if(!e.isEmpty(b)&&c){var d=a.search()[b];d?(d=JSON.parse(d),d.push(c),a.search(b,JSON.stringify(d))):a.search(b,JSON.stringify([c]))}else a.search(b,null)},e.setDateFilter=function(b){"Last Day"===b?a.search("after","now-24H"):"Last Week"===b?a.search("after","now-1w"):"Last Month"===b?a.search("after","now-1M"):a.search("after",null)},e.isEmpty=function(a){return _.isEmpty(e.aggregations[a])},e.format=function(a){return a?moment(a).format("YYYY-MM-DD"):null},e.hasFilter=function(a,c){return"desk"===a?e.tags.selectedFacets[a]&&e.tags.selectedFacets[a].indexOf(b.deskLookup[c].name)>=0:e.tags.selectedFacets[a]&&e.tags.selectedFacets[a].indexOf(c)>=0}}}}]).directive("sdSearchTags",["$location","$route","tags","asset","metadata",function(a,b,c,d,e){return{scope:{},templateUrl:d.templateUrl("superdesk-search/views/search-tags.html"),link:function(b,d){c.initSelectedFacets().then(function(a){b.tags=a}),b.removeFilter=function(a,b){c.removeFacet(a,b)},b.removeParameter=function(b){var c=a.search();if(c.q&&(c.q=c.q.replace(b,"").trim(),a.search("q",c.q||null),-1!==b.indexOf("subject.name:"))){var d=b.substring(b.lastIndexOf("(")+1,b.lastIndexOf(")"));e.removeSubjectTerm(d)}}}}}]).directive("sdSearchResults",["$location","preferencesService","packages","tags","asset",function(a,b,c,d,e){var f={"archive:view":{allowed:["mgrid","compact"],category:"archive",view:"mgrid","default":"mgrid",label:"Users archive view format",type:"string"}};return{require:"^sdSearchContainer",templateUrl:e.templateUrl("superdesk-search/views/search-results.html"),link:function(d,e,g,h){function i(a){d.view=a||"mgrid",f["archive:view"].view=a||"mgrid",b.update(f,"archive:view")}function j(){var a=d.view===l?k:l;return i(a)}var k="mgrid",l="compact",m=void 0===g.multiSelectable?!1:!0;d.flags=h.flags,d.selected=d.selected||{},d.preview=function(b){m&&(-1===_.findIndex(d.selectedList,{_id:b._id})?d.selectedList.push(b):_.remove(d.selectedList,{_id:b._id})),d.selected.preview=b,a.search("_id",b?b._id:null)},d.openLightbox=function(){d.selected.view=d.selected.preview},d.closeLightbox=function(){d.selected.view=null},d.openSingleItem=function(a){c.fetchItem(a).then(function(a){d.selected.view=a})},d.setview=i;var n;b.get("archive:view").then(function(a){n=a.view,d.view=n&&"undefined"!==n?n:"mgrid"}),d.$on("key:v",j)}}}]).directive("sdSearchWithin",["$location","asset",function(a,b){return{scope:{},templateUrl:b.templateUrl("superdesk-search/views/search-within.html"),link:function(b,c){b.searchWithin=function(){if(b.within){var c=a.search();c.q?b.query=c.q+" ("+b.within+") ":b.query="("+b.within+")",a.search("q",b.query||null),b.within=null}}}}}]).directive("sdItemContainer",["$filter","desks","api",function(a,b,c){return{scope:{item:"="},template:"{{item.container}}",link:function(a,c){"ingest"!==a.item._type&&(a.item.task&&a.item.task.desk?b.initialize().then(function(){b.deskLookup[a.item.task.desk]&&(a.item.container="desk:"+b.deskLookup[a.item.task.desk].name)}):"archive"===a.item._type?a.item.container="location:workspace":"published"===a.item._type&&a.item.allow_post_publish_actions===!1&&(a.item.container="archived"))}}}]).directive("sdItemPreview",["asset",function(a){return{templateUrl:a.templateUrl("superdesk-search/views/item-preview.html"),scope:{item:"=",close:"&",openLightbox:"=",openSingleItem:"="},link:function(a){a.tab="content",a.$watch("item",function(b){a.selected={preview:b||null}})}}}]).directive("sdItemGlobalsearch",["superdesk","session","$location","search","api","notify","gettext","keyboardManager","asset",function(a,b,c,d,e,f,g,h,i){return{scope:{repo:"=",context:"="},templateUrl:i.templateUrl("superdesk-search/views/item-globalsearch.html"),link:function(c,d){function i(){c.meta.unique_name=""}function j(b){b.length>0?(i(),c.flags.enabled=!1,"composite"===b[0].type?a.intent("author","package",b[0]):a.intent("author","article",b[0])):(f.error(g("Item not found...")),c.flags.enabled=!0)}function k(a){var d=e("user_content",b.identity);d.query(a).then(function(a){j(a._items)},function(a){c.message=g("There was a problem, item can not open.")})}function l(){var a=[{not:{term:{state:"spiked"}}},{term:{unique_name:c.meta.unique_name}}],b={repo:"ingest,archive,published,archived",source:{query:{filtered:{filter:{and:a}}}}};e.query("search",b).then(function(a){c.items=a._items,c.items.length>0?(j(c.items),i()):k(b)},function(a){c.message=g("There was a problem, item can not open.")})}function m(){i(),c.flags.enabled=!1}var n=13,o=27;c.meta={},c.flags={enabled:!1};var p={global:!0};h.bind("ctrl+0",function(){c.flags.enabled=!0},p),h.bind("esc",function(){c.flags.enabled=!1},p),c.search=function(){l()},c.openOnEnter=function(a){a.keyCode===n&&(c.search(),a.stopPropagation()),a.keyCode===o&&m()},c.close=function(){m()}}}}]).directive("sdItemSearchbar",["$location","$document","asset",function(a,b,c){return{templateUrl:c.templateUrl("superdesk-search/views/item-searchbar.html"),link:function(c,d){function e(){c.$apply(function(){c.focused=!1})}var f=13;c.focused=!1;var g=d.find("#search-input");c.searchOnEnter=function(a){a.keyCode===f&&(c.search(),a.stopPropagation())},c.search=function(){a.search("q",c.query||null)},c.cancel=function(){c.query=null,c.search(),g.focus()};var h=a.search();h.q&&""!==h.q?c.query=h.q:c.query=null,b.bind("click",e),c.$on("$destroy",function(){b.unbind("click",e)})}}}]).directive("sdItemSearch",["$location","$timeout","asset","api","tags","search","metadata",function(a,b,c,d,e,f,g){return{scope:{repo:"=",context:"="},templateUrl:c.templateUrl("superdesk-search/views/item-search.html"),link:function(c,h){function i(){var b=a.search();if(c.query=b.q,c.flags=!1,c.meta={},j(),b.repo){var d=b.repo.split(",");c.repo.archive=d.indexOf("archive")>=0,c.repo.ingest=d.indexOf("ingest")>=0,c.repo.published=d.indexOf("published")>=0,c.repo.archived=d.indexOf("archived")>=0}c.repo?c.repo.archive||c.repo.ingest||c.repo.published||c.repo.archived?c.repo.search="local":c.repo.search=b.repo:c.repo={search:"local"}}function j(){return d.ingestProviders.query({max_results:200}).then(function(a){c.providers=a._items})}function k(){var a=[];return"local"===c.repo.search?(angular.forEach(c.repo,function(b,c){b&&"local"!==b&&a.push(c)}),a.length?a.join(","):null):c.repo.search}function l(a){for(var b in a)if(a.hasOwnProperty(b))return b}function m(){var a=[];return angular.forEach(c.meta,function(b,c){if("_all"===c)a.push(b.join(" "));else if(b)if("string"==typeof b)b&&a.push(c+":("+b+")");else{var d=l(b);b[d]&&a.push(c+"."+d+":("+b[d]+")")}}),a.length?c.query?c.query+" "+a.join(" "):a.join(" "):c.query||null}function n(){c.query=a.search().q,a.search("q",m()||null),a.search("repo",k()),c.meta={}}var o=h.find("#search-input");i(),c.$on("$locationChangeSuccess",function(){c.query!==a.search().q&&i()}),c.focusOnSearch=function(){c.advancedOpen&&c.toggle(),o.focus()},c.search=function(){n()},c.$on("key:s",function(){c.$apply(function(){c.flags={extended:!0},b(function(){o.focus()},0,!1)})}),g.fetchSubjectcodes().then(function(){return c.subjectcodes=g.values.subjectcodes,e.initSelectedFacets()}).then(function(a){c.subjectitems={subject:f.getSubjectCodes(a,c.subjectcodes)}}),c.subjectSearch=function(b){e.initSelectedFacets().then(function(d){var e=f.getSubjectCodes(d,c.subjectcodes);if(b.subject.length>e.length){var g="subject.name:("+b.subject[b.subject.length-1].name+")",h=m(),i=null===h?g:h+" "+g;a.search("q",i)}else{var j=a.search();if(j.q)for(var k=0;k<e.length;k++)if(-1===b.subject.indexOf(e[k])){var l="subject.name:("+e[k].name+")";j.q=j.q.replace(l,"").trim(),a.search("q",j.q||null)}}})}}}}]).directive("sdItemSortbar",["search","asset",function(a,b){return{scope:{},templateUrl:b.templateUrl("superdesk-search/views/item-sortbar.html"),link:function(b){function c(){b.active=a.getSort()}b.sortOptions=a.sortOptions,b.sort=function(b){a.setSort(b)},b.toggleDir=function(b){a.toggleSortDir()},b.$on("$routeUpdate",c),c()}}}]).directive("sdSavedSearchSelect",["api","session",function(a,b){return{link:function(c){a.query("saved_searches",{},b.identity).then(function(a){c.searches=a._items})}}}]).directive("sdSavedSearches",["api","session","$location","notify","gettext","asset",function(a,b,c,d,e,f){return{templateUrl:f.templateUrl("superdesk-search/views/saved-searches.html"),
scope:{},link:function(f){var g=a("saved_searches",b.identity);f.selected=null,f.editSearch=null,g.query().then(function(a){f.views=a._items}),f.select=function(a){f.selected=a,c.search(a.filter.query)},f.edit=function(){f.editSearch={}},f.cancel=function(){f.editSearch=null},f.save=function(a){a.filter={query:c.search()},g.save({},a).then(function(a){d.success(e("Saved search created")),f.cancel(),f.views.push(a)},function(){d.error(e("Error. Saved search not created."))})},f.remove=function(a){g.remove(a).then(function(){d.success(e("Saved search removed")),_.remove(f.views,{_id:a._id})},function(){d.error(e("Error. Saved search not deleted."))})}}}}]).directive("sdSearchContainer",function(){return{controller:["$scope",function(a){this.flags=a.flags||{}}]}}).directive("sdMultiActionBar",["asset","multi",function(a,b){return{controller:"MultiActionBar",controllerAs:"action",templateUrl:a.templateUrl("superdesk-search/views/multi-action-bar.html"),scope:!0,link:function(a){function c(b){var c={},d=[];angular.forEach(b,function(a){c[a._type]=1,d.push(a.state)});var e=Object.keys(c);a.type=1===e.length?e[0]:null,a.state=1===e.length?d[0]:null}a.multi=b,a.$watch(b.getItems,c)}}}]).config(["superdeskProvider","assetProvider",function(a,b){a.activity("/search",{description:gettext("Find live and archived content"),priority:200,category:a.MENU_MAIN,label:gettext("Search"),controller:c,templateUrl:b.templateUrl("superdesk-search/views/search.html"),sideTemplateUrl:"scripts/superdesk-workspace/views/workspace-sidenav.html"})}]),d.$inject=["$rootScope","multi","multiEdit","send","packages","superdesk","notify","spike","authoring"]}(),function(){"use strict";function a(a,b,c,d,e){function f(){var a=(d.search().sort||"versioncreated:desc").split(":");return angular.extend(_.find(l,{field:a[0]}),{dir:a[1]})}function g(a){var b=_.find(l,{field:a});j(b.field,b.defaultDir||"desc")}function h(){var a=f(),b="asc"===a.dir?"desc":"asc";j(a.field,b)}function i(a,b){var c="asc"===b?1:-1;return'[("'+encodeURIComponent(a)+'", '+c+")]"}function j(a,b){d.search("sort",a+":"+b),d.search("page",null)}var k=25;this.default_items=Object.freeze({_meta:{max_results:k,page:1,total:1}});var l=[{field:"versioncreated",label:e("Updated")},{field:"firstcreated",label:e("Created")},{field:"urgency",label:e("News Value")},{field:"anpa_category.name",label:e("Category")},{field:"slugline",label:e("Slugline")},{field:"priority",label:e("Priority")}];g("versioncreated"),this.setSort=g,this.getSort=f,this.sortOptions=l,this.toggleSortDir=h,this.getCriteria=function(){var a=d.search(),b={max_results:Number(a.max_results)||k};if(a.q&&(b.where=a.q),a.page&&(b.page=parseInt(a.page,10)),a.sort){var c=a.sort.split(":");b.sort=i(c[0],c[1])}return b},this.updateSearchQuery=function(a){function b(a){return _.trunc(a,{length:a.length-3,omission:""})+"00"}var c=[],e=!1;_.forEach(a,function(a,d){var f=_.trim(a);if(f){var g={};"published_after"===d?g.versioncreated={$gte:b(f)}:"published_before"===d?g.versioncreated={$lte:b(f)}:"_id"===d?(g._id=f,e=!0):g[d]={$regex:f,$options:"-i"},c.push(g)}});var f=null;return e&&1===c.length?f=JSON.stringify(c[0]):c.length>0&&(f=JSON.stringify({$and:c})),d.search("q",f),f},this.query=function(){var a=this.getCriteria();return b.legal_archive.query(a)}}function b(a,b,c,d){function e(){a.loading=!0,c.query().then(function(b){a.loading=!1,a.items=b})}var f={"archive:view":{allowed:["mgrid","compact"],category:"archive",view:"mgrid","default":"mgrid",label:"Users archive view format",type:"string"}};a.criteria={},a.items=c.default_items,a.loading=!1,a.selected={},a.openAdvanceSearch=!1,a.extras={activity:{action:"list"}},a.search=function(){c.updateSearchQuery(a.criteria),e()},a.preview=function(b){a.selected.preview=b},a.openLightbox=function(){a.selected.view=a.selected.preview},a.closeLightbox=function(){a.selected.view=null},a.clear=function(){c.criteria=a.criteria={},a.search()},a.$watch(function(){return _.omit(b.search(),"_id")},e,!0),a.setview=function(b){a.view=b||"mgrid",f["archive:view"].view=b||"mgrid",d.update(f,"archive:view")},a.search(),d.get("archive:view").then(function(b){var c=b.view;a.view=c&&"undefined"!==c?c:"mgrid"})}a.$inject=["$q","api","notify","$location","gettext"],b.$inject=["$scope","$location","legal","preferencesService"];var c=angular.module("superdesk.legal_archive",["superdesk.activity","superdesk.api"]);return c.service("legal",a).directive("sdLegalItemSortbar",["legal","asset",function(a,b){return{scope:{},templateUrl:b.templateUrl("superdesk-search/views/item-sortbar.html"),link:function(b){function c(){b.active=a.getSort()}b.sortOptions=a.sortOptions,b.sort=function(b){a.setSort(b)},b.toggleDir=function(b){a.toggleSortDir()},b.$on("$routeUpdate",c),c()}}}]).config(["apiProvider",function(a){a.api("legal_archive",{type:"http",backend:{rel:"legal_archive"}}),a.api("legal_archive_versions",{type:"http",backend:{rel:"legal_archive_versions"}})}]).config(["superdeskProvider",function(a){a.activity("/legal_archive/",{label:gettext("Legal Archive"),description:gettext("Confidential data"),priority:100,controller:b,templateUrl:"scripts/superdesk-legal-archive/views/legal_archive.html",sideTemplateUrl:"scripts/superdesk-workspace/views/workspace-sidenav.html",category:a.MENU_MAIN,reloadOnSearch:!1,filters:[],privileges:{legal_archive:1}})}]),c}(),function(){"use strict";var a=angular.module("superdesk.stream",["superdesk.activity","superdesk.asset"]);a.controller("StreamController",["$scope","api","$rootScope","desks",function(a,b,c,d){a.desk=null,a.activities=null,a.pageLength=10,a.max_results=a.pageLength,a.loadMore=function(){a.activities._meta.total>a.max_results&&(a.max_results+=a.pageLength,e())},a.showDateHeader=function(b){if(a.currentDate=new Date(a.activities._items[b.index]._created),0===b.index)return!0;var c=new Date(a.activities._items[b.index-1]._created);return c.getYear()!==a.currentDate.getYear()||c.getMonth()!==a.currentDate.getMonth()||c.getDate()!==a.currentDate.getDate()};var e=function(){var c={embedded:{user:1,item:1},max_results:a.max_results};a.desk&&(c.where={desk:a.desk._id}),b("activity").query(c).then(function(b){a.activities=b})};a.$watch("desk",function(){e()}),c.$on("activity",function(a,b){e()})}]).directive("sdActivityStream",["asset",function(a){return{scope:{activities:"=",max_results:"=maxResults",loadMore:"&"},templateUrl:a.templateUrl("superdesk-stream/views/activity-stream.html")}}]).directive("sdActivityMessage",[function(){return{scope:{activity:"="},template:"{{display_message}}",link:function(a,b,c){if("notify"!==a.activity.name){a.display_message=a.activity.message;for(var d in a.activity.data)if(a.activity.data.hasOwnProperty(d)){var e=new RegExp("{{\\s*"+d+"\\s*}}","gi");a.display_message=a.display_message.replace(e,a.activity.data[d])}}}}}]).config(["superdeskProvider","assetProvider","gettext",function(a,b,c){a.activity("/workspace/stream",{label:c("Workspace"),controller:"StreamController",templateUrl:b.templateUrl("superdesk-stream/views/workspace-stream.html"),topTemplateUrl:b.templateUrl("superdesk-dashboard/views/workspace-topnav.html")})}])}(),function(){"use strict";function a(a,b,c,d,e,f){function g(a,b){var c=[];return a&&c.push({headline:a.headline||"",residRef:a._id,location:"archive",slugline:a.slugline||"",renditions:a.renditions||{}}),{refs:c,id:b,role:"grpRole:"+b}}function h(a,b){return(angular.isUndefined(b)||!_.isObject(b))&&(b={}),c.addTaskToArticle(b),_.merge(a,b)}function i(a){return{headline:a.headline||"",residRef:a._id,location:"archive",slugline:a.slugline||"",renditions:a.renditions||{},itemClass:a.type?"icls:"+a.type:""}}this.groupList=["main","story","sidebars","fact box"],this.fetch=function(b){return a.find("archive",b).then(function(a){return a})},this.open=function(a,b){return f.open(a,b)},this.createPackageFromItems=function(b,c){var d="main",e=b[0],f={headline:e.headline||e.description||"",slugline:e.slugline||"",description:e.description||"",state:"draft",type:"composite"},i=[{role:"grpRole:NEP",refs:[{idRef:d}],id:"root"},g(null,d)];return f=h(f,c),f.groups=i,this.addItemsToPackage(f,d,b),a.archive.save(f)},this.createEmptyPackage=function(b,c){c=c||"main";var d={headline:"",slugline:"",description:"",type:"composite",groups:[{role:"grpRole:NEP",refs:[{idRef:c}],id:"root"},g(null,c)]};return d=h(d,b),a.save("archive",d)},this.addItemsToPackage=function(a,b,c){var d=_.cloneDeep(a.groups),e=_.find(d,function(a){return a.id.toLowerCase()===b});if(!e){var f=_.find(d,{id:"root"});f.refs.push({idRef:b}),e={id:b,refs:[],role:"grpRole:"+b},d.push(e)}_.each(c,function(a){e.refs.push(i(a))}),_.extend(a,{groups:d})},this.fetchItem=function(b){var c=b.location||"ingest";return a(c).getById(b.residRef).then(function(a){return a},function(a){404===a.status&&console.log("Item not found")})}}function b(a,b,c,d,e,f,g,h){a.origItem=b,a.action="edit",a.lock=function(){h.intent("author","package",b)},a.highlight=!!b.highlight}function c(a,b,c,d){function e(){if(h){var b={};b.q=a.query,b.ignoreKilled=!0,b.ignoreDigital=!0;var e=d.query(b);e.size(25),a.highlight&&e.filter({term:{highlights:a.highlight.toString()}});var f=e.getCriteria(!0);f.repo="archive,published",c.query("search",f).then(function(b){a.contentItems=b._items})}}function f(){var b=[];a.item.groups&&_.each(a.item.groups,function(a){"root"!==a.id&&_.each(a.refs,function(a){b.push(a.residRef)})}),g=b}a.selected=null,a.multiSelected=[],a.query=null,a.highlight=null;var g=null,h=!1;a.groupList=b.groupList,e(),a.$watch("query",function(a){e()}),a.$watch("highlight",function(a){e()}),a.$watch("item",function(b){a.highlight=b.highlight,a.highlight?c("highlights").getById(a.highlight).then(function(b){a.groupList=b.groups,h=!0,e()},function(a){h=!0,e()}):(h=!0,e())}),a.$watch("item.groups",function(){f()},!0),a.addItemToGroup=function(c,d){b.addItemsToPackage(a.item,c,[d]),a.autosave(a.item)},a.preview=function(b){a.selected=b},a.itemInPackage=function(a){return _.indexOf(g,a._id)>-1},a.addToSelected=function(b){b.multi?a.multiSelected.push(b):_.remove(a.multiSelected,b)},a.addMultiItemsToGroup=function(c){b.addItemsToPackage(a.item,c,a.multiSelected),a.autosave(a.item),_.each(a.multiSelected,function(a){a.multi=!1}),a.multiSelected=[]}}function d(){return{link:function(a,b){function c(b){0===$(b.target).closest(".group-select").length&&a.$apply(function(){a.preview(a.pitem)})}b.bind("click",c),a.$on("$destroy",function(){b.unbind("click",c)})}}}function e(a){return{templateUrl:"scripts/superdesk-packaging/views/sd-package-edit.html",link:function(b){b.limits=a.limits,b._editable=b.origItem._editable,b._isInPublishedStates=a.isPublished(b.origItem)}}}function f(){return{scope:!1,require:"ngModel",templateUrl:"scripts/superdesk-packaging/views/sd-package-items-edit.html",link:function(a,b,c,d){function e(){d.$setViewValue({list:a.list}),a.autosave(a.item)}d.$render=function(){a.list=d.$viewValue},d.$parsers.unshift(function(a){var b=null;return a&&a.list&&(b=[],b.push({role:"grpRole:NEP",refs:_.map(a.list,function(a){return{idRef:a.id}}),id:"root"}),_.each(a.list,function(a){b.push({id:a.id,role:"grpRole:"+a.id,refs:a.items})})),b}),d.$formatters.unshift(function(a){function b(d){var e=_.find(a,{id:d}),f=[];return _.each(e.refs,function(a){c(a)?f=_.union(f,b(a.idRef)):f.push(a)}),f}function c(a){return angular.isDefined(a.idRef)}var d=_.find(a,{id:"root"}),e=_.map(d.refs,function(a){return{id:a.idRef,items:[]}});return _.each(e,function(a){a.items=b(a.id)}),e}),a.remove=function(b,c){var d=_.find(a.list,{id:b});_.remove(d.items,{residRef:c}),e()},a.reorder=function(b,c){var d=_.find(a.list,{id:b.group}),f=_.find(a.list,{id:c.group});b.index!==c.index||b.group!==c.group?f.items.splice(c.index,0,d.items.splice(b.index,1)[0]):f.items=_.cloneDeep(f.items),e()}}}}function g(){return{link:function(a,b){var c=!1;b.sortable({items:".package-edit-items li",cursor:"move",containment:".package-edit-container",tolerance:"pointer",placeholder:{element:function(a){var b=a.height()-40;return $('<li class="placeholder" style="height:'+b+'px"></li>')[0]},update:function(){}},start:function(a,b){b.item.data("start_index",b.item.parent().find("li.sort-item").index(b.item)),b.item.data("start_group",b.item.parent().data("group"))},stop:function(b,d){if(c){c=!1;var e={index:d.item.data("start_index"),group:d.item.data("start_group")},f={index:d.item.parent().find("li.sort-item").index(d.item),group:d.item.parent().data("group")};d.item.remove(),a.reorder(e,f),a.$apply()}},update:function(a,b){c=!0},cancel:".fake"})}}}function h(a,b){return{templateUrl:"scripts/superdesk-packaging/views/sd-package-item-preview.html",link:function(c){if(c.data=null,c.error=null,c.item.location){var d="";c.item._current_version&&(d="?version="+c.item._current_version),a.archive.getByUrl("archive/"+c.item.residRef+d).then(function(a){c.data=a,c.isLocked=b.isLocked(c.data),c.isPublished="published"===c.data.state},function(a){c.error=!0})}c.$on("item:lock",function(a,d){c.data&&c.data._id===d.item&&c.$applyAsync(function(){c.data.lock_user=d.user,c.isLocked=b.isLocked(c.data)})}),c.$on("item:unlock",function(a,b){c.data&&c.data._id===b.item&&c.$applyAsync(function(){c.data.lock_user=null,c.isLocked=!1})}),c.$on("item:publish",function(a,b){c.data&&c.data._id===b.item&&c.$applyAsync(function(){c.isPublished=!0})})}}}function i(){var a=function(b,c){var d={childId:"_items",childData:[]},e=[d];return _.each(b.refs,function(b){b.idRef?e.push({childId:b.idRef,childData:a(_.find(c,{id:b.idRef}),c)}):b.residRef&&d.childData.push(b)}),e};return{templateUrl:"scripts/superdesk-packaging/views/sd-package.html",scope:{item:"=",setitem:"&"},link:function(b,c,d){b.mode=d.mode||"tree",b.$watchGroup(["item","item.groups"],function(){b.item&&b.item.groups&&(b.tree=a(_.find(b.item.groups,{id:"root"}),b.item.groups))})}}}function j(){return{templateUrl:"scripts/superdesk-packaging/views/sd-package-item.html",scope:{id:"=",item:"=",setitem:"&",mode:"="},link:function(a,b){}}}function k(a){var b='<div sd-package-item data-id="id" data-item="item" data-setitem="setitem({selected: selected})" data-mode="mode"></div>';return{scope:{id:"=",item:"=",setitem:"&",mode:"="},link:function(c,d){d.append(a(b)(c))}}}function l(a,b){return{templateUrl:"scripts/superdesk-packaging/views/sd-package-ref.html",scope:{item:"=",setitem:"&"}}}function m(a){return{templateUrl:"scripts/superdesk-packaging/views/packaging.html",require:"^sdAuthoringContainer",scope:{item:"="},link:function(b,c,d,e){b.$watch("item",function(a){a&&a.lockIt?b.lock():(b.origItem=null,b.$applyAsync(function(){b.origItem=a,b.action="view"}))}),b.lock=function(){a.open(b.item._id).then(function(a){b.origItem=a,b.action="edit"})}}}}a.$inject=["api","$q","archiveService","lock","autosave","authoring"],b.$inject=["$scope","item","packages","api","modal","notify","gettext","superdesk"],c.$inject=["$scope","packages","api","search"],e.$inject=["authoring"],h.$inject=["api","lock"],k.$inject=["$compile"],l.$inject=["api","$rootScope"],m.$inject=["packages"];var n=angular.module("superdesk.packaging",["superdesk.api","superdesk.activity","superdesk.authoring"]);return n.service("packages",a).directive("sdPackageEdit",e).directive("sdPackageItemsEdit",f).directive("sdSortPackageItems",g).directive("sdPackage",i).directive("sdPackageItem",j).directive("sdPackageItemProxy",k).directive("sdPackageRef",l).directive("sdPackageItemPreview",h).directive("sdWidgetPreventPreview",d).directive("sdPackagingEmbedded",m).config(["superdeskProvider",function(a){a.activity("packaging",{category:"/authoring",href:"/packaging/:_id",when:"/packaging/:_id",label:gettext("Packaging"),templateUrl:"scripts/superdesk-packaging/views/packaging.html",topTemplateUrl:"scripts/superdesk-dashboard/views/workspace-topnav.html",sideTemplateUrl:"scripts/superdesk-workspace/views/workspace-sidenav.html",controller:b,filters:[{action:"author",type:"package"}],resolve:{item:["$route","authoring",function(a,b){return b.open(a.current.params._id,!1)}]},authoring:!0}).activity("edit.package",{label:gettext("Edit package"),priority:10,icon:"pencil",controller:["data","authoringWorkspace",function(a,b){b.edit(a.item)}],filters:[{action:"list",type:"archive"}],condition:function(a){return!_.contains(["published","killed","corrected"],a.state)&&"composite"===a.type&&"takes"!==a.package_type},additionalCondition:["authoring","item",function(a,b){return a.itemActions(b).package_item}]}).activity("view.package",{label:gettext("View item"),priority:2e3,icon:"external",controller:["data","authoringWorkspace",function(a,b){b.view(a.item)}],filters:[{action:"list",type:"archive"},{action:"list",type:"legal_archive"}],condition:function(a){return"composite"===a.type}}).activity("read_only.content_package",{category:"/packaging",href:"/packaging/:_id/view/:_type",when:"/packaging/:_id/view/:_type",label:gettext("Packaging Read Only"),templateUrl:"scripts/superdesk-packaging/views/packaging.html",topTemplateUrl:"scripts/superdesk-dashboard/views/workspace-topnav.html",sideTemplateUrl:"scripts/superdesk-workspace/views/workspace-sidenav.html",controller:b,filters:[{action:"read_only",type:"content_package"}],resolve:{item:["$route","authoring",function(a,b){return b.open(a.current.params._id,!0,a.current.params._type)}]},authoring:!0}).activity("create.package",{label:gettext("Create package"),controller:["data","packages","authoringWorkspace",function(a,b,c){function d(a){c.edit(a)}if(a&&a.items)b.createPackageFromItems(a.items,a.defaults).then(d);else{var e=a&&a.defaults?a.defaults:{};b.createEmptyPackage(e).then(d)}}],filters:[{action:"create",type:"package"}],condition:function(a){return a?"killed"!==a.state&&"takes"!==a.package_type:!0}}).activity("packageitem",{label:gettext("Package item"),priority:5,icon:"package-plus",controller:["data","packages","authoringWorkspace","notify","gettext",function(a,b,c,d,e){b.createPackageFromItems([a.item]).then(function(a){c.edit(a)},function(a){403===a.status&&a.data&&a.data._message&&d.error(e(a.data._message),3e3)})}],filters:[{action:"list",type:"archive"}],additionalCondition:["authoring","item",function(a,b){return a.itemActions(b).package_item}],group:"packaging"})}]).config(["apiProvider",function(a){a.api("archive",{type:"http",backend:{rel:"archive"}})}]).config(["authoringWidgetsProvider",function(a){a.widget("search",{icon:"view",label:gettext("Search"),template:"scripts/superdesk-packaging/views/search.html",order:4,side:"left",extended:!0,display:{authoring:!1,packages:!0,legalArchive:!1}})}]).controller("SearchWidgetCtrl",c),n}(),function(){"use strict";function a(a,b,c,d){var e={},f={},g=c("highlightList");return e.get=function(c){var d="_nodesk",e=c||d,h=g.get(e);if(h)return b.when(h);if(f[e])return f[e];var i={};return c&&(i={where:{$or:[{desks:c},{desks:{$size:0}}]}}),f[e]=a("highlights").query(i).then(function(a){return g.put(e,a),f[e]=null,b.when(a)}),f[e]},e.clearCache=function(){g.removeAll(),f={}},e.markItem=function(b,c){return a.markForHighlights.create({highlights:b,marked_item:c})},e.createEmptyHighlight=function(a){var b={headline:a.name,highlight:a._id},c=null;return a.groups&&a.groups.length>0&&(c=a.groups[0]),d.createEmptyPackage(b,c)},e.find=function(b){return a.find("highlights",b)},e}function b(a,b){return{templateUrl:"scripts/superdesk-highlights/views/mark_highlights_dropdown_directive.html",link:function(c){c.markItem=function(a){b.markItem(a._id,c.item._id),c.item.highlights?c.item.highlights=[a._id].concat(c.item.highlights):c.item.highlights=[a._id]},c.isMarked=function(a){return c.item&&c.item.highlights&&c.item.highlights.indexOf(a._id)>=0},b.get(a.getCurrentDeskId()).then(function(a){c.highlights=a._items})}}}function c(a,b,c){return{templateUrl:"scripts/superdesk-highlights/views/mark_highlights_dropdown_directive.html",link:function(d){d.markItem=function(a){angular.forEach(c.getItems(),function(c){if(c.highlights){if(-1!==c.highlights.indexOf(a._id))return;c.highlights=[a._id].concat(c.highlights)}else c.highlights=[a._id];b.markItem(a._id,c._id)}),c.reset()},d.isMarked=function(a){var b=_.find(c.getItems(),function(b){return!b.highlights||-1===b.highlights.indexOf(a._id)});return!b},b.get(a.getCurrentDeskId()).then(function(a){d.highlights=a._items})}}}function d(a,b){return{scope:{item:"=item",orientation:"=?"},templateUrl:"scripts/superdesk-highlights/views/highlights_title_directive.html",link:function(c,d){function e(){b(function(){j[0].dispatchEvent(new CustomEvent("toggle"))},0,!1)}function f(b){a.markItem(b,c.item._id).then(function(){c.item.highlights=_.without(c.item.highlights,b)})}var g,h,i=d.find(".unmark").hide(),j=d.find("i");c.orientation=c.orientation||"right",c.$watch("item.highlights",function(b){b&&a.get().then(function(a){c.highlights=_.filter(a._items,function(a){return b.indexOf(a._id)>=0}),c.$applyAsync(function(){c.htmlTooltip=i.html()})})}),c.openTooltip=function(){b.cancel(h),h=null,g||(e(),g=!0)},c.closeTooltip=function(){g&&!h&&(h=b(function(){e(),g=!1},100,!1))},d.on("click",function(a){a.preventDefault(),a.stopPropagation();var b="BUTTON"===a.target.nodeName?a.target:a.target.parentNode,c=b.attributes["data-highlight"];c&&f(c.value)})}}}function e(a){return{scope:{highlight_id:"=highlight"},templateUrl:"scripts/superdesk-highlights/views/search_highlights_dropdown_directive.html",link:function(b){b.selectHighlight=function(a){b.highlight_id=null,a&&(b.highlight_id=a._id)},b.hasHighlights=function(){return _.size(b.highlights)>0},a.get().then(function(a){b.highlights=a._items})}}}function f(a,b,c,d){return{scope:!0,templateUrl:"scripts/superdesk-highlights/views/package_highlights_dropdown_directive.html",link:function(e){e.$watch(function(){return a.active},function(a){e.selected=a,b.get(a.desk).then(function(a){e.highlights=a._items,e.hasHighlights=_.size(e.highlights)>0})}),e.listHighlight=function(a){c.url("workspace/highlights?highlight="+a._id),d.reload()}}}}function g(a,b){return{scope:{highlight_id:"=highlight"},template:"<span translate>{{ highlightItem.name }}</span>",link:function(c){b.get(a.getCurrentDeskId()).then(function(a){c.highlightItem=_.find(a._items,{_id:c.highlight_id})})}}}function h(a,b){return{scope:{highlight_id:"=highlight"},templateUrl:"scripts/superdesk-highlights/views/create_highlights_button_directive.html",link:function(c){c.createHighlight=function(){a.find(c.highlight_id).then(a.createEmptyHighlight).then(b.edit)}}}}function i(a,b){b.initialize().then(function(){a.desks=b.deskLookup}),a.hours=_.range(1,25),a.auto={day:"now/d",week:"now/w"}}function j(a,b,c,d,e,f,g){function h(b){return _.map(a.desks,function(a){return{_id:a._id,name:a.name,included:i(b,a._id)}})}function i(a,b){return _.findIndex(a,function(a){return a===b})>-1}function j(){return _.map(_.filter(a.assignedDesks,{included:!0}),function(a){return a._id})}b.get().then(function(b){a.configurations=b}),a.configEdit={},a.modalActive=!1,a.limits=45;var k;a.edit=function(b){a.message=null,a.modalActive=!0,a.configEdit=_.create(b),a.assignedDesks=h(b.desks),a.editingGroup=null,a.selectedGroup=null,k=b,a.configEdit.auto_insert||(a.configEdit.auto_insert="now/d"),a.configEdit.groups||(a.configEdit.groups=[])},a.cancel=function(){a.modalActive=!1},a.save=function(){function c(b){b.data&&b.data._issues&&b.data._issues.name&&b.data._issues.name.unique?a.message=e("Highlight configuration with the same name already exists."):a.message=e("There was a problem while saving highlights configuration")}var f=!k._id;a.configEdit.desks=j(),0===a.configEdit.groups.length?a.configEdit.groups=["main"]:a.configEdit.groups=a.configEdit.groups.slice(0),d.highlights.save(k,a.configEdit).then(function(c){a.message=null,f&&a.configurations._items.unshift(c),b.clearCache(),a.modalActive=!1},function(a){c(a)})},a.remove=function(b){g.confirm(e("Are you sure you want to delete configuration?")).then(function(){d.highlights.remove(b).then(function(){_.remove(a.configurations._items,b),f.success(e("Configuration deleted."),3e3)})})},a.getHourVal=function(a){return"now-"+a+"h"},a.isActiveGroup=function(b){return a.editingGroup&&a.editingGroup.id&&a.configEdit.groups[a.editingGroup.id-1]===b},a.editGroup=function(b){""!==b?a.editingGroup={name:b,id:a.configEdit.groups.indexOf(b)+1}:a.editingGroup={name:"",id:0}},a.removeGroup=function(b){a.configEdit.groups.splice(a.configEdit.groups.indexOf(b),1)},a.cancelGroup=function(){a.editingGroup=null,a.selectedGroup=null},a.saveGroup=function(){0===a.editingGroup.id?a.configEdit.groups.push(a.editingGroup.name):a.editingGroup.id>0&&(a.configEdit.groups[a.editingGroup.id-1]=a.editingGroup.name),a.cancelGroup()},a.handleGroupEdit=function(b){a._errorLimits=null,a.editingGroup&&a.editingGroup.name&&(a._errorLimits=a.editingGroup.name.length>a.limits?!0:null)}}a.$inject=["api","$q","$cacheFactory","packages"],b.$inject=["desks","highlightsService"],c.$inject=["desks","highlightsService","multi"],d.$inject=["highlightsService","$timeout"],e.$inject=["highlightsService"],f.$inject=["desks","highlightsService","$location","$route"],g.$inject=["desks","highlightsService"],h.$inject=["highlightsService","authoringWorkspace"],i.$inject=["$scope","desks"],j.$inject=["$scope","highlightsService","desks","api","gettext","notify","modal"];var k=angular.module("superdesk.highlights",["superdesk.desks","superdesk.packaging","superdesk.activity","superdesk.api"]);return k.service("highlightsService",a).directive("sdCreateHighlightsButton",h).directive("sdMarkHighlightsDropdown",b).directive("sdMultiMarkHighlightsDropdown",c).directive("sdPackageHighlightsDropdown",f).directive("sdHighlightsTitle",d).directive("sdSearchHighlights",e).directive("sdHighlightsConfig",function(){return{controller:j}}).directive("sdHighlightsConfigModal",function(){return{require:"^sdHighlightsConfig",templateUrl:"scripts/superdesk-highlights/views/highlights_config_modal.html",link:function(a,b,c,d){}}}).directive("sdHighlightLabel",g).config(["superdeskProvider",function(a){a.activity("mark.item",{label:gettext("Mark for highlight"),priority:30,icon:"list-plus",dropdown:!0,templateUrl:"scripts/superdesk-highlights/views/mark_highlights_dropdown.html",filters:[{action:"list",type:"archive"}],additionalCondition:["authoring","item",function(a,b){return a.itemActions(b).mark_item}],group:"highlights"}).activity("/settings/highlights",{label:gettext("Highlights"),controller:i,templateUrl:"scripts/superdesk-highlights/views/settings.html",category:a.MENU_SETTINGS,priority:-800,privileges:{highlights:1}}).activity("/workspace/highlights",{label:gettext("Highlights View"),priority:100,templateUrl:"scripts/superdesk-monitoring/views/highlights-view.html",topTemplateUrl:"scripts/superdesk-dashboard/views/workspace-topnav.html",sideTemplateUrl:"scripts/superdesk-workspace/views/workspace-sidenav.html"})}]).config(["apiProvider",function(a){a.api("highlights",{type:"http",backend:{rel:"highlights"}}),a.api("markForHighlights",{type:"http",backend:{rel:"marked_for_highlights"}}),a.api("generate_highlights",{type:"http",backend:{rel:"generate_highlights"}})}]),k}(),function(){"use strict";function a(a,b,c,d,e){function f(a){a.user&&(a.name=a.user+":"+a.language_id)}function g(b){function d(b){return a.find("dictionaries",b._id)}return c.getIdentity().then(function(c){return a.query("dictionaries",{projection:{content:0},where:{language_id:b,is_active:{$in:["true",null]},$or:[{user:c._id},{user:{$exists:!1}}]}}).then(function(a){return e.all(a._items.map(d))})})}function h(b){return c.getIdentity().then(function(c){return a.query("dictionaries",{where:{language_id:b,user:c._id}}).then(function(a){return a._items.length?a._items[0]:{name:c._id+":"+b,content:{},language_id:b,user:c._id}})})}function i(b,c){return h(c).then(function(c){var d=c.content||{};return d[b]=d[b]?d[b]+1:1,c.content=d,a.save("dictionaries",c)})}this.dictionaries=null,this.currDictionary=null,this.getActive=g,this.getUserDictionary=h,this.addWordToUserDictionary=i,this.fetch=function(b,d){return c.getIdentity().then(function(c){return a.query("dictionaries",{projection:{content:0},where:{$or:[{user:{$exists:!1}},{user:c._id}]}}).then(b,d)})},this.open=function(b,c,d){return a.find("dictionaries",b._id).then(c,d)},this.upload=function(a,c,e,g,h,i){var j=_.has(a,"_id")&&null!==a._id,k=j?"PATCH":"POST",l=j?{"If-Match":a._etag}:{},m={};angular.forEach(c,function(a,b){"content"!==b&&(m[b]=null===a?a:a.toString())}),f(m),c.hasOwnProperty("content")&&(m.content_list=angular.toJson(c.content)),b.resource("dictionaries").then(function(b){return j&&(b+="/"+a._id),d.upload({url:b,method:k,data:m,file:e,headers:l}).then(g,h,i)},h)},this.update=function(b,c,d,e){var g={};return angular.forEach(c,function(a,b){g[b]="is_active"===b?a.toString():a}),f(g),a.save("dictionaries",b,g).then(d,e)},this.remove=function(b,c,d){return a.remove(b).then(c,d)}}function b(a,b,c,d,e,f){a.dictionaries=null,a.origDictionary=null,a.dictionary=null,a.fetchDictionaries=function(){b.fetch(function(b){a.dictionaries=b})},a.createDictionary=function(){a.dictionary={is_active:"true"},a.origDictionary={}},a.createPersonalDictionary=function(){return d.getIdentity().then(function(b){a.dictionary={is_active:"true",user:b._id,name:b._id},a.origDictionary={}})},a.openDictionary=function(c){b.open(c,function(b){a.origDictionary=b,a.dictionary=_.create(b),a.dictionary.content=_.create(b.content||{}),a.dictionary.is_active="false"!==a.dictionary.is_active})},a.closeDictionary=function(){a.dictionary=a.origDictionary=null},a.remove=function(d){e.confirm(c("Please confirm you want to delete dictionary.")).then(function(){b.remove(d,function(){_.remove(a.dictionaries._items,d),f.success(c("Dictionary deleted."),3e3)})})},a.fetchDictionaries()}function c(a,b,c,d,e,f){function g(b){return a.closeDictionary(),a.fetchDictionaries(),e.success(d("Dictionary saved succesfully")),a.progress=null,b}function h(b){angular.isDefined(b.data._issues)?angular.isDefined(b.data._issues["validator exception"])?e.error(d("Error: "+b.data._issues["validator exception"])):angular.isDefined(b.data._issues.name)&&(e.error(d("Error: The dictionary already exists.")),a._errorUniqueness=!0):e.error(d("Error. Dictionary not saved.")),a.progress=null}function i(a,b){return b.length>=a.length&&b.substr(0,a.length)===a}function j(a){k.hasOwnProperty(a[0])?k[a[0]].push(a):k[a[0]]=[a]}a.$on("fileSelected",function(b,c){a.$apply(function(){a.file=c.file})}),a.save=function(){a._errorUniqueness=!1,a.progress={width:1},a.file?b.upload(a.origDictionary,a.dictionary,a.file,g,h,function(b){a.progress.width=Math.round(b.loaded/b.total*100)}):b.update(a.origDictionary,a.dictionary,g,h)},a.cancel=function(){a._errorUniqueness=!1,a.closeDictionary()},a.addWord=function(b){a.dictionary.content.hasOwnProperty(b)||j(b),a.dictionary.content[b]=1,a.filterWords(b),a.wordsCount++},a.removeWord=function(b,c){a.dictionary.content[b]=0,a.filterWords(c),a.wordsCount--},a.filterWords=function(b){if(a.words=[],a.isNew=!!b,b&&k[b[0]]){for(var c,d=k[b[0]],e=d.length,f=[],g=0;e>g;g++)c=d[g],a.dictionary.content[c]>0&&i(b,c)&&(f.push(c),c.length===b.length&&(a.isNew=!1));var h=10;f.sort(),f.splice(h,f.length-h),a.words=f}};var k={};a.wordsCount=0;for(var l in a.dictionary.content)(a.dictionary.content.hasOwnProperty(l)||a.origDictionary.content.hasOwnProperty(l))&&(j(l),a.wordsCount++)}a.$inject=["api","urls","session","$upload","$q"],b.$inject=["$scope","dictionaries","gettext","session","modal","notify"],c.$inject=["$scope","dictionaries","upload","gettext","notify","modal"];var d=angular.module("superdesk.dictionaries",["superdesk.activity","superdesk.upload"]);d.config(["superdeskProvider",function(a){a.activity("/settings/dictionaries",{label:gettext("Dictionaries"),controller:b,templateUrl:"scripts/superdesk-dictionaries/views/settings.html",category:a.MENU_SETTINGS,priority:-800,privileges:{dictionaries:1}})}]).service("dictionaries",a).controller("DictionaryEdit",c).directive("sdDictionaryConfig",function(){
return{controller:b}}).directive("sdDictionaryConfigModal",function(){return{controller:"DictionaryEdit",require:"^sdDictionaryConfig",templateUrl:"scripts/superdesk-dictionaries/views/dictionary-config-modal.html"}}).directive("fileUpload",function(){return{scope:!0,link:function(a,b,c){b.bind("change",function(b){a.$emit("fileSelected",{file:b.target.files[0]})})}}})}(),function(){"use strict";return angular.module("superdesk.archive.directives",["superdesk.authoring","superdesk.ingest","superdesk.workflow"]).directive("sdItemLock",["api","lock","privileges",function(a,b,c){return{templateUrl:"scripts/superdesk-archive/views/item-lock.html",scope:{item:"="},link:function(d){function e(){d.privileges=c.privileges,d.lock={user:null,lockbyme:!1}}e(),d.$watch("item.lock_session",function(){e(),d.item&&b.isLocked(d.item)&&a("users").getById(d.item.lock_user).then(function(a){d.lock.user=a,d.lock.lockbyme=b.isLockedByMe(d.item)})}),d.unlock=function(){b.unlock(d.item).then(function(){d.item.lock_user=null,d.item.lock_session=null,d.lock=null,d.isLocked=!1})},d.can_unlock=function(){return b.can_unlock(d.item)},d.$on("item:lock",function(a,b){d.item&&d.item._id===b.item&&(d.item.lock_user=b.user,d.item.lock_time=b.lock_time,d.item.lock_session=b.lock_session,d.$digest())}),d.$on("item:unlock",function(a,b){d.item&&d.item._id===b.item&&(d.item.lock_user=null,d.item.lock_session=null,d.$digest())})}}}]).directive("sdInlineMeta",function(){return{templateUrl:"scripts/superdesk-archive/views/inline-meta.html",scope:{placeholder:"@",showmeta:"=",item:"=",setmeta:"&"}}}).directive("sdMediaPreview",[function(){return{templateUrl:"scripts/superdesk-archive/views/preview.html"}}]).directive("sdMediaPreviewWidget",[function(){return{scope:{item:"="},templateUrl:"scripts/superdesk-archive/archive-widget/item-preview.html"}}]).directive("sdMediaView",["keyboardManager","packages",function(a,b){return{templateUrl:"scripts/superdesk-archive/views/media-view.html",scope:{items:"=",item:"=",close:"&"},link:function(c,d){var e=[];c.singleItem=null,c.packageItem=null,c.prevEnabled=!0,c.nextEnabled=!0;var f=function(a){return _.findIndex(c.items,{_id:a._id})},g=function(a){i(),c.item=a,c.openItem(a);var b=f(c.item);c.prevEnabled=b>-1&&!!c.items[b-1],c.nextEnabled=b>-1&&!!c.items[b+1]};c.prev=function(){var a=f(c.item);a>0&&g(c.items[a-1])},c.next=function(){var a=f(c.item);-1!==a&&a<c.items.length-1&&g(c.items[a+1])},a.push("left",c.prev),a.push("right",c.next),c.$on("$destroy",function(){a.pop("left"),a.pop("right")}),c.setPackageSingle=function(a){b.fetchItem(a).then(function(a){c.openItem(a)})},c.openItem=function(a){"composite"===a.type&&(e.push(a),h()),c.setSingleItem(a)},c.setSingleItem=function(a){c.singleItem=a},c.nested=function(){return e.length>1},c.previousPackage=function(){_.remove(e,_.last(e)),h(),c.setSingleItem(c.packageItem)};var h=function(){c.packageItem=_.last(e)||null},i=function(){e=[],c.packageItem=null};g(c.item)}}}]).directive("sdMediaMetadata",["userList","archiveService",function(a,b){return{scope:{item:"="},templateUrl:"scripts/superdesk-archive/views/metadata-view.html",link:function(c,d){function e(){c.originalCreator=c.item.original_creator,c.versionCreator=c.item.version_creator,b.isLegal(c.item)||(c.item.original_creator&&a.getUser(c.item.original_creator).then(function(a){c.originalCreator=a.display_name}),c.item.version_creator&&a.getUser(c.item.version_creator).then(function(a){c.versionCreator=a.display_name}))}c.$watch("item",e)}}}]).directive("sdMediaRelated",["familyService","superdesk",function(a,b){return{scope:{item:"="},templateUrl:"scripts/superdesk-archive/views/related-view.html",link:function(c,d){c.$watch("item",function(){a.fetchItems(c.item.family_id||c.item._id,c.item).then(function(a){c.relatedItems=a})}),c.open=function(a){b.intent("read_only","content_article",a)}}}}]).directive("sdFetchedDesks",["desks","familyService","$location",function(a,b,c){return{scope:{item:"="},templateUrl:"scripts/superdesk-archive/views/fetched-desks.html",link:function(d,e){d.$watchGroup(["item","item.archived"],function(){d.item&&b.fetchDesks(d.item,!1).then(function(a){d.desks=a})}),d.selectFetched=function(b){a.setCurrentDeskId(b.desk._id),c.path("/workspace/content").search("_id="+b.itemId)}}}}]).directive("sdMetaIngest",["ingestSources",function(a){var b=a.initialize();return{scope:{item:"="},template:"{{name}}",link:function(c){c.$watch("item",function(){c.name="",!c.item.ingest_provider&&"source"in c.item&&(c.name=c.item.source),b.then(function(){c.item.ingest_provider&&c.item.ingest_provider in a.providersLookup&&(c.name=a.providersLookup[c.item.ingest_provider].name)})})}}}]).directive("sdSingleItem",[function(){return{templateUrl:"scripts/superdesk-archive/views/single-item-preview.html",scope:{item:"=",contents:"=",setitem:"&"}}}]).directive("sdMediaBox",["$location","lock","multi","archiveService",function(a,b,c,d){return{restrict:"A",templateUrl:"scripts/superdesk-archive/views/media-box.html",link:function(e,f,g){e.lock={isLocked:!1},e.$watch("view",function(a){switch(a){case"mlist":case"compact":e.itemTemplate="scripts/superdesk-archive/views/media-box-list.html";break;default:e.itemTemplate="scripts/superdesk-archive/views/media-box-grid.html"}}),e.$watch("item",function(a){e.lock.isLocked=a&&(b.isLocked(a)||b.isLockedByMe(a))}),e.$on("item:lock",function(a,b){e.item&&e.item._id===b.item&&(e.lock.isLocked=!0,e.item.lock_user=b.user,e.item.lock_session=b.lock_session,e.item.lock_time=b.lock_time,e.$digest())}),e.$on("item:unlock",function(a,b){e.item&&e.item._id===b.item&&(e.lock.isLocked=!1,e.item.lock_user=null,e.item.lock_session=null,e.item.lock_time=null,e.$digest())}),e.$on("task:progress",function(a,b){b.task===e.item.task_id&&(0===b.progress.total?e._progress=10:e._progress=Math.min(100,Math.round(100*b.progress.current/b.progress.total)),e.$digest())}),e.clickAction=function(b){return"function"==typeof e.preview?(a.search("fetch",null),e.preview(b)):!1},e.toggleSelected=function(a){c.toggle(a)},e.getType=function(a){return d.getType(a)}}}}]).directive("sdItemRendition",function(){return{templateUrl:"scripts/superdesk-archive/views/item-rendition.html",scope:{item:"=",rendition:"@",ratio:"=?"},link:function(a,b){function c(){var c=b.find("figure");if(c&&a.ratio){var d=c.find("img")[0],e=d?d.naturalWidth/d.naturalHeight:1;a.ratio>e?c.parent().addClass("portrait"):c.parent().removeClass("portrait")}}a.$watch("item.renditions[rendition].href",function(a){var d=b.find("figure"),e=d.find("img").css("opacity",.5);if(a){var f=new Image;f.onload=function(){e.length?e.replaceWith(f):d.html(f),c()},f.onerror=function(){d.html("")},f.src=a}});var d=a.$watch("ratio",function(a){void 0===a&&d(),e()}),e=_.debounce(c,150)}}}).directive("sdRatioCalc",["$window",function(a){return{link:function(b,c){function d(){b.ratio=c.outerWidth()/c.outerHeight()}function e(){d(),b.$apply()}var f=angular.element(a);d(),f.bind("resize",e),b.$on("$destroy",function(){f.unbind("resize",e)})}}}]).directive("sdHtmlPreview",["$sce",function(a){return{scope:{sdHtmlPreview:"="},template:'<div ng-bind-html="html"></div>',link:function(b,c,d){b.$watch("sdHtmlPreview",function(c){b.html=a.trustAsHtml(c)})}}}]).directive("sdProviderMenu",["$location",function(a){return{scope:{items:"="},templateUrl:"scripts/superdesk-archive/views/provider-menu.html",link:function(b,c,d){b.setProvider=function(c){b.selected=c,a.search("provider",b.selected)},b.$watchCollection(function(){return a.search()},function(a){a.provider&&(b.selected=a.provider)})}}}]).directive("sdGridLayout",function(){return{templateUrl:"scripts/superdesk-items-common/views/grid-layout.html",scope:{items:"="},link:function(a,b,c){a.view="mgrid",a.preview=function(b){a.previewItem=b}}}}).service("familyService",["api","desks",function(a,b){this.fetchItems=function(b,c){var d="archive";c&&"published"===c._type&&(d="published");var e=[{not:{term:{state:"spiked"}}},{term:{family_id:b}}];return c&&"published"!==c._type&&e.push({not:{term:{_id:c._id}}}),a(d).query({source:{query:{filtered:{filter:{and:e}}},sort:[{versioncreated:"desc"}],size:100,from:0}})},this.fetchDesks=function(a,c){return this.fetchItems("ingested"===a.state?a._id:a.family_id,c?a:void 0).then(function(a){var c=[],d=[];return _.each(a._items,function(a){a.task&&a.task.desk&&b.deskLookup[a.task.desk]&&(d.indexOf(a.task.desk)<0?(c.push({desk:b.deskLookup[a.task.desk],count:1,itemId:a._id}),d.push(a.task.desk)):c[d.indexOf(a.task.desk)].count+=1)}),c})}}])}(),function(){"use strict";function a(a,b,c){function d(){return f?(g||(g=c.getActive(f).then(function(a){return g.content={},angular.forEach(a,e),g.content})),g):a.reject()}function e(a){angular.extend(g.content,a.content||{})}var f,g,h;this.setLanguage=function(a){f!==a&&(f=a,g=null)},this.errors=function(a){return d().then(function(b){for(var c,d=[],e=/[0-9a-zA-Z\u00C0-\u1FFF\u2C00-\uD7FF]+/g,f=0,i=document.createTreeWalker(a,NodeFilter.SHOW_TEXT);i.nextNode();){for(;null!=(c=e.exec(i.currentNode.textContent));){var j=c[0];isNaN(j)&&!g.content[j.toLowerCase()]&&d.push({word:j,index:f+c.index})}f+=i.currentNode.length}return h=d.length,d})},this.countErrors=function(){return h},this.suggest=function(a){return b.save("spellcheck",{word:a,language_id:f}).then(function(a){return a.corrections||[]})},this.addWordToUserDictionary=function(a){a=a.toLowerCase(),c.addWordToUserDictionary(a,f),g.content[a]=g.content[a]?g.content[a]+1:1}}function b(a,b){function c(){a.setSettings({spellcheck:!0}),a.render(),a.setSettings({spellcheck:!1})}function d(){a.setSettings({spellcheck:e.isAuto})}this.isAuto=a.settings.spellcheck||!0,this.spellcheck=c,this.pushSettings=d;var e=this}a.$inject=["$q","api","dictionaries"],b.$inject=["editor","$rootScope"],angular.module("superdesk.editor.spellcheck",["superdesk.dictionaries","superdesk.editor"]).service("spellcheck",a).controller("SpellcheckMenu",b)}(),function(){"use strict";function a(a){a.activity("/workspace/monitoring",{label:gettext("Monitoring"),priority:100,templateUrl:"scripts/superdesk-monitoring/views/monitoring.html",topTemplateUrl:"scripts/superdesk-dashboard/views/workspace-topnav.html",sideTemplateUrl:"scripts/superdesk-workspace/views/workspace-sidenav.html"})}function b(a){a.activity("/workspace/spike-monitoring",{label:gettext("Spike Monitoring"),priority:100,templateUrl:"scripts/superdesk-monitoring/views/spike-monitoring.html",topTemplateUrl:"scripts/superdesk-dashboard/views/workspace-topnav.html",sideTemplateUrl:"scripts/superdesk-workspace/views/workspace-sidenav.html"})}function c(a,b,c){function d(a,d,e){var f={};f.spike="spike"===a.type,a.fileType&&(f.type=a.fileType),"search"===a.type&&a.search&&a.search.filter.query.q?a.query?f.q="("+a.query+") "+a.search.filter.query.q:f.q=a.search.filter.query.q:f.q=a.query;var g=b.query(f);switch(a.type){case"search":break;case"personal":g.filter({bool:{must:{term:{original_creator:c.identity._id}},must_not:{exists:{field:"task.desk"}}}});break;case"spike":g.filter({term:{"task.desk":a._id}});break;case"highlights":g.filter({and:[{term:{highlights:e.highlight}}]});break;default:g.filter({term:{"task.stage":a._id}})}d&&g.filter({query:{query_string:{query:d,lenient:!1}}});var h={source:g.getCriteria()};return"search"===a.type&&a.search&&a.search.filter.query.repo&&(h.repo=a.search.filter.query.repo),h.source.from=0,h.source.size=25,h}this.criteria=d}function d(a){function b(a){f.previewItem=a,f.state["with-preview"]=!!a}function c(){b(null)}function d(a){f.editItem=a,f.state["with-authoring"]=!!a}function e(a){f.singleGroup=a}this.state={},this.preview=b,this.closePreview=c,this.previewItem=null,this.singleGroup=null,this.viewSingleGroup=e,this.queryParam=a.search(),this.edit=d,this.editItem=null;var f=this}function e(){return{templateUrl:"scripts/superdesk-monitoring/views/monitoring-view.html",controller:"Monitoring",controllerAs:"monitoring",scope:{type:"=",state:"="}}}function f(){return{templateUrl:"scripts/superdesk-monitoring/views/monitoring-group-header.html"}}function g(a,b,c,d,e){function f(a){return a._id}var g=57,h=5,i=8,j=-1,k=1,l=13,m={38:j,40:k};return{templateUrl:"scripts/superdesk-monitoring/views/monitoring-group.html",require:["^sdMonitoringView"],scope:{group:"=",numItems:"=",viewType:"="},link:function(c,j,k,n){function o(a,b){d.edit(a,!b),B.preview(null)}function p(a){c.selected=a,B.preview(a)}function q(a){p(a)}function r(){return E=a.criteria(c.group,null,B.queryParam),E.source.size=0,c.loading=!0,c.total=null,t().then(function(a){c.total=a._meta.total,c.$applyAsync(s)})["finally"](function(){c.loading=!1})}function s(){var a=D[0].scrollTop,b=Math.floor(a/g),d=Math.max(0,b-i),e=c.numItems||h,f=Math.min(c.total,b+e+i);return parseInt(C.style.height,10)!==c.total*g&&(C.style.height=c.total*g+"px"),E.source.from=d,E.source.size=f-d,t().then(function(a){c.$applyAsync(function(){c.total!==a._meta.total&&(c.total=a._meta.total,C.style.height=c.total*g+"px"),C.style.paddingTop=d*g+"px",c.items=w(a._items)})})}function t(){return b.query(E.repo?"search":"archive",E)}function u(){c.total+=c.newItemsCount,c.newItemsCount=0,s()}function v(a){B.viewSingleGroup(a)}function w(a){var b=[],d=c.items||[];return angular.forEach(a,function(a){var c=_.find(d,{_id:a._id});b.push(c?angular.extend(c,a):a)}),b}function x(a){e.cancel(F),F=e(s,100,!1)}function y(a){var b=a.keyCode||a.which;m[b]?(a.preventDefault(),a.stopPropagation(),e.cancel(F),A(m[b],a),x()):b===l&&c.$applyAsync(function(){o(c.selected)})}function z(a,b){c.select(a),b&&(b.preventDefault(),b.stopPropagation(),b.stopImmediatePropagation())}function A(a,b){var d,f,i=_.findIndex(c.items,c.selected),j=c.numItems||h;-1===i?d=c.items[0]:(f=Math.max(0,Math.min(c.items.length-1,i+a)),d=c.items[f],e.cancel(G),G=e(function(){var a=D[0].scrollTop,b=Math.ceil(a/g),c=Math.floor((a+D[0].clientHeight)/g),d=f+E.source.from;b>d?D[0].scrollTop=Math.max(0,d*g):d>=c&&(D[0].scrollTop=(d-j+1)*g)},50,!1)),c.$apply(function(){z(c.items[f],b)})}var B=n[0];c.view="compact",c.page=1,c.fetching=!1,c.cacheNextItems=[],c.cachePreviousItems=[],c.limited=B.singleGroup||"highlights"===c.group.type?!1:!0,c.uuid=f,c.edit=o,c.select=p,c.preview=q,c.renderNew=u,c.viewSingleGroup=v,c.$watchCollection("group",r),c.$on("task:stage",r),c.$on("ingest:update",r),c.$on("item:spike",r),c.$on("item:unspike",r);var C=j[0].getElementsByClassName("inline-content-items")[0],D=j.find(".stage-content").first();D.on("keydown",y),D.on("scroll",x),c.$on("$destroy",function(){D.off()});var E,F,G}}}function h(a,b,c,d){return{scope:{item:"=",active:"="},templateUrl:"scripts/superdesk-monitoring/views/item-actions-menu.html",link:function(e){function f(b){var d={action:"list",type:g(b)},f={};return a.findActivities(d,b).forEach(function(a){if(c.isActionAllowed(e.item,a.action)){var b=a.group||"default";f[b]=f[b]||[],f[b].push(a)}}),f}function g(a){return d.getType(a)}e.toggleActions=function(a){e.actions=a?f(e.item):e.actions,e.open=a},e.stopEvent=function(a){a.stopPropagation()},e.run=function(a){return b.start(a,{data:{item:e.item}})}}}}angular.module("superdesk.monitoring",["superdesk.api","superdesk.aggregate","superdesk.search"]).service("cards",c).controller("Monitoring",d).directive("sdMonitoringView",e).directive("sdMonitoringGroup",g).directive("sdMonitoringGroupHeader",f).directive("sdItemActionsMenu",h).config(a).config(b),a.$inject=["superdeskProvider"],b.$inject=["superdeskProvider"],c.$inject=["api","search","session"],d.$inject=["$location"],g.$inject=["cards","api","desks","authoringWorkspace","$timeout"],h.$inject=["superdesk","activityService","workflowService","archiveService"]}(),function(){"use strict";function a(a,b,c,d,e){function f(b){return b.user=b.user||c.identity._id,a.save(r,b).then(j)}function g(b){return a.remove(b).then(function(){return s.active&&s.active._id===b._id?s.queryUserWorkspaces():e.when()}).then(function(a){a&&a.length?s.setActive(a[0]):s.setActive(null),s.getActive()})}function h(a){j(a);var b={};b[q]={workspace:a?a._id:""},d.update(b,q)}function i(a){return h(null),n(a._id,a.name).then(j)}function j(a){return s.active=a||null,a}function k(){return d.get(q).then(function(a){return a&&a.workspace?a.workspace:null})}function l(){return b.fetchCurrentDeskId().then(k).then(function(a){return a?m(a):b.activeDeskId?n(b.activeDeskId):o()}).then(j)}function m(b){return a.find(r,b)}function n(b){return a.query("desks",{where:{desk:b}}).then(function(a){return 1===a._items.length?a._items[0]:{desk:b,widgets:[]}})}function o(){return{user:c.identity._id,widgets:c.identity.workspace?c.identity.workspace.widgets:[]}}function p(){return c.getIdentity().then(function(b){return a.query(r,{where:{user:b._id}})}).then(function(a){return a._items})}this.active=null,this.save=f,this["delete"]=g,this.setActive=h,this.setActiveDesk=i,this.getActive=l,this.getActiveId=k,this.queryUserWorkspaces=p;var q="workspace:active",r="workspaces",s=this}function b(a,b,c,d,e,f){return{templateUrl:"scripts/superdesk-workspace/views/workspace-dropdown.html",link:function(c){function d(){e.search("_id",null)}function g(){var d=null;b.getActiveId().then(function(a){d=a}).then(angular.bind(a,a.initialize)).then(angular.bind(a,a.fetchCurrentUserDesks)).then(function(a){c.desks=a._items}).then(b.queryUserWorkspaces).then(function(b){c.wsList=b,d?c.selected=_.find(c.wsList,{_id:d}):c.selected=_.find(c.desks,{_id:a.getCurrentDeskId()})})}c.workspaces=b,c.wsList=null,c.edited=null,c.afterSave=function(d){a.setCurrentDeskId(null),b.setActive(d),c.selected=d},c.selectDesk=function(e){d(),c.selected=e,c.workspaceType="desk",a.setCurrentDeskId(e._id),b.setActiveDesk(e),f.activeDesk=a.active.desk},c.selectWorkspace=function(e){d(),c.selected=e,c.workspaceType="workspace",a.setCurrentDeskId(null),b.setActive(e)},c.createWorkspace=function(){c.edited={}},c.$watch(function(){return b.active},g,!0)}}}function c(){return{templateUrl:"scripts/superdesk-workspace/views/workspace-sidenav-items.html",link:function(a){a.hideMonitoring=function(b,c){var d=a.$parent.flags;d.authoring&&b?(c.preventDefault(),d.hideMonitoring=!d.hideMonitoring):d.hideMonitoring=!1}}}}function d(a){return{templateUrl:"scripts/superdesk-workspace/views/edit-workspace-modal.html",scope:{workspace:"=",done:"="},link:function(b){b.workspaces=a,b.save=function(){a.save(b.workspace).then(function(){b.errors=null;var a=b.workspace;return b.workspace=null,b.done?b.done(a):void 0},function(a){b.errors=a.data._issues})},b.cancel=function(){b.workspace=null}}}}angular.module("superdesk.workspace",["superdesk.workspace.content"]).service("workspaces",a).directive("sdDeskDropdown",b).directive("sdWorkspaceSidenav",c).directive("sdEditWorkspace",d),a.$inject=["api","desks","session","preferencesService","$q"],b.$inject=["desks","workspaces","$route","preferencesService","$location","reloadService"],c.$inject=[],d.$inject=["workspaces"]}();